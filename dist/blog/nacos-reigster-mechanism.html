<!DOCTYPE html><html lang="en" data-theme="light" class="astro-37fxchfa"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="referrer" content="no-referrer"><meta name="generator" content="Astro v3.6.4"><title>Nacos Blog</title><style>.sl-markdown-content :not(h1,h2,h3,h4,h5,h6)+:is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){margin-top:2.5rem;scroll-margin-top:4rem}.sl-markdown-content li+li:not(:where(.not-content *)),.sl-markdown-content dt+dt:not(:where(.not-content *)),.sl-markdown-content dt+dd:not(:where(.not-content *)),.sl-markdown-content dd+dd:not(:where(.not-content *)){margin-top:.25rem}.sl-markdown-content li>:last-child:not(li,ul,ol):not(a,strong,em,del,span,input,:where(.not-content *)){margin-bottom:1.25rem}.sl-markdown-content dt:not(:where(.not-content *)){font-weight:700}.sl-markdown-content dd:not(:where(.not-content *)){padding-inline-start:1rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){color:#f4f4f6;line-height:var(--sl-line-height-headings);font-weight:600}.sl-markdown-content :is(img,picture,video,canvas,svg,iframe):not(:where(.not-content *)){display:block;max-width:100%;height:auto}.sl-markdown-content h1:not(:where(.not-content *)){font-size:var(--sl-text-h1)}.sl-markdown-content h2:not(:where(.not-content *)){font-size:var(--sl-text-h2)}.sl-markdown-content h3:not(:where(.not-content *)){font-size:var(--sl-text-h3)}.sl-markdown-content h4:not(:where(.not-content *)){font-size:var(--sl-text-h4)}.sl-markdown-content h5:not(:where(.not-content *)){font-size:var(--sl-text-h5)}.sl-markdown-content h6:not(:where(.not-content *)){font-size:var(--sl-text-h6)}.sl-markdown-content a:not(:where(.not-content *)){color:var(--sl-color-text-accent)}.sl-markdown-content a:hover:not(:where(.not-content *)){color:var(--sl-color-white)}.sl-markdown-content code:not(:where(.not-content *)){background-color:var(--sl-color-bg-inline-code);margin-block:-.125rem;padding:.125rem .375rem;font-size:var(--sl-text-code-sm)}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) code{font-size:inherit}.sl-markdown-content pre:not(:where(.not-content *)){border:1px solid var(--sl-color-gray-5);padding:.75rem 1rem;font-size:var(--sl-text-code);-moz-tab-size:2;-o-tab-size:2;tab-size:2}.sl-markdown-content pre code:not(:where(.not-content *)){all:unset;font-family:var(--__sl-font-mono)}.sl-markdown-content blockquote:not(:where(.not-content *)){border-inline-start:1px solid var(--sl-color-gray-5);padding-inline-start:1rem}.sl-markdown-content table:not(:where(.not-content *)){display:block;overflow:auto;border-collapse:collapse}.sl-markdown-content tr:nth-child(2n):not(:where(.not-content *)){background-color:var(--sl-color-gray-7, var(--sl-color-gray-6))}.sl-markdown-content :is(th,td):not(:where(.not-content *)){border:1px solid var(--sl-color-hairline-light);padding:.375rem .8125rem}.sl-markdown-content hr:not(:where(.not-content *)){border:0;border-bottom:1px solid var(--sl-color-hairline)}.sl-markdown-content h2{line-height:3.5rem}main:where(.astro-bvzihdzo){width:calc(100% - 2em);max-width:100%;margin:0}.hero-image:where(.astro-bvzihdzo){width:100%}.hero-image:where(.astro-bvzihdzo) img:where(.astro-bvzihdzo){display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.nacos-prose:where(.astro-bvzihdzo){width:90%;padding:1em;color:rgb(var(--gray-dark))}.title:where(.astro-bvzihdzo){margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title:where(.astro-bvzihdzo) h1:where(.astro-bvzihdzo){margin:0 0 .5em}.date:where(.astro-bvzihdzo){margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on:where(.astro-bvzihdzo){font-style:italic}
</style>
<link rel="stylesheet" href="/_astro/index.96ed717d.css" />
<style>@media (max-width: 36rem){html{font-size:12px}}
</style><script type="module" src="/_astro/hoisted.a3604078.js"></script></head> <body class="astro-37fxchfa"> <header-layout class="header bg-gray-14 relative astro-3ef6ksr2" style="position: sticky; height: 4rem"> <div data-modal-panel class="modal-panel hidden h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2"></div> <div style="height: 4rem" class="nav bg-gray-14 relative top-0 right-0 bottom-0 left-0 flex items-center justify-between astro-3ef6ksr2"> <!-- logo --> <a href="/" class="astro-3ef6ksr2"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png"> </a> <!-- 菜单 --> <div class="pc_nav_menu flex h-full items-center astro-3ef6ksr2"> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-docs class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">DOCS</span> <svg data-docs-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2"></path> </svg> </div> <div data-docs-dropdown style="top: 4rem" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 astro-3ef6ksr2"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">Documentation</span> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <span class="text-sm text-gray-02 astro-3ef6ksr2">1.x</span> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <span class="text-sm text-gray-02 astro-3ef6ksr2">2.x</span> </a> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-nacos-cloud class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">NACOS CLOUD</span> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-community class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">COMMUNITY</span> <svg data-community-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2"></path> </svg> </div> <div data-community-dropdown style="top: 4rem" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 z-50 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 justify-center astro-3ef6ksr2"> <div class="flex mr-32 astro-3ef6ksr2"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">COMMUNITY</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Contact</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Report</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Contribute</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Stars</a> </div> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">EVENTS</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Events</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">News</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Meetup</a> <span class="text-xs text-gray-10 mb-2 mt-10 astro-3ef6ksr2">Resources</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/blog">Blog</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/docs/ebook/iez8a4">E-book</a> </div> </div> <div class="flex astro-3ef6ksr2"> <div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2"> <img class=" astro-3ef6ksr2" src="/left-shortcut.png"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2">Key to service-centric (for example microservice or cloud-native) architectures.</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2">READ ARTICLE</button> </div><div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2"> <img class=" astro-3ef6ksr2" src="/right-shortcut.png"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2">An easy-to-use platform for building cloud native applications</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2">READ ARTICLE</button> </div> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-demo class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">DEMO</span> </div> </div> </div> <!-- 右侧菜单 --> <div class="astro-3ef6ksr2">  </div> <!-- 小屏适配 --> <div class="mobile_nav_menu hidden cursor-pointer astro-3ef6ksr2"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2"> <svg class="cursor-pointer icon ml-8 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6304" width="24" height="24"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 479.169H438.553c-17.673 0-32 14.327-32 32s14.327 32 32 32h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM319.028 351.594l-160 160 160 160z" fill="#f4f4f6" p-id="6305" class="astro-3ef6ksr2"></path></svg> </button> </div> <!-- 移动端导航菜单 --> <div data-mobile-menu class="overflow-hidden hidden flex flex-col w-screen bg-gray-01 h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2"> <!-- 顶部logo --> <div style="height: 4rem" class="bg-gray-14 px-8 flex items-center justify-start astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png"> </a> <div class="menu_close flex items-center cursor-pointer astro-3ef6ksr2"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2"> <svg class="cursor-pointer icon ml-8 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7494" id="mx_n_1702523741163" width="24" height="24"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM192.028 543.17h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.028c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM705.162 671.594l160-160-160-160z" fill="#f4f4f6" p-id="7495" class="astro-3ef6ksr2"></path></svg> </button> </div> </div> <div data-mobile-menu-list class="w-full pl-8 astro-3ef6ksr2"> <ul class="list-none pl-0 astro-3ef6ksr2"> <li class="astro-3ef6ksr2"> <div mobile-menu-expand-docs class="astro-3ef6ksr2"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2">DOCS</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2"></path></svg> </button> </div> <div mobile-menu-expand-content-docs class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2"> <div mobile-menu-fold-docs class="flex items-center pt-8 pb-4 astro-3ef6ksr2"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2">DOCS</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2"></div> <div class="astro-3ef6ksr2"> <span class="text-xs text-gray-12 astro-3ef6ksr2">Documentation</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <li class="text-sm text-gray-14 astro-3ef6ksr2">1.x</li> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <li class="text-sm text-gray-14 astro-3ef6ksr2">2.x</li> </a> </ul> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2"> <a href="/nacosCloud" class="text-gray-14 text-sm astro-3ef6ksr2">NACOS CLOUD</a> </li> <li class="astro-3ef6ksr2"> <div mobile-menu-expand-com class="astro-3ef6ksr2"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2">COMMUNITY</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2"></path></svg> </button> </div> <div mobile-menu-expand-content-com class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2"> <div mobile-menu-fold-com class="flex items-center pt-8 pb-4 astro-3ef6ksr2"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2">COMMUNITY</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2"></div> <div class="mobile_menu_community flex justify-between astro-3ef6ksr2"> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">COMMUNITY</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Contact </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Report </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Contribute </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Stars </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">EVENTS</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Events </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> News </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Meetup </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">Resources</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/blog" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Blog </li> </a><a href="/docs/ebook/iez8a4" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> E-book </li> </a> </ul> </div> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2"> <a href="/" class="text-gray-14 text-sm astro-3ef6ksr2">DEMO</a> </li> </ul> </div> </div> </div> </header-layout>    <div class="bg-gray-14 "> <div class="w-[70%] inline-block"> <div class="sl-markdown-content bg-gray-14 text-gray-01 astro-bvzihdzo"> <div class="hero-image  astro-bvzihdzo">  </div> <div class="nacos-prose mx-auto astro-bvzihdzo"> <div class="title astro-bvzihdzo"> <div class="date astro-bvzihdzo"> <time datetime="2022-12-28T00:00:00.000Z"> Dec 28, 2022 </time>  </div> <h1 class="astro-bvzihdzo">Nacos 的一条注册请求会经历什么？</h1> <hr class="astro-bvzihdzo"> </div>  <p>转载且编辑自<a href="http://www.passjava.cn/#/13.SpringCloud%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/07.Nacos%E9%85%8D%E7%BD%AE%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/02.Nacos%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E2%91%A0%EF%BC%9A%E4%B8%80%E6%9D%A1%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82%E4%BC%9A%E7%BB%8F%E5%8E%86%E4%BB%80%E4%B9%88%EF%BC%9F" rel="noopener noreferrer" target="_blank">Nacos 的一条注册请求会经历什么?</a></p>
<h1 id="前言">前言</h1>
<p>Nacos 作为注册中心，用来接收客户端（服务实例）发起的注册请求，并将注册信息存放到注册中心进行管理。</p>
<blockquote>
<p>那么一条注册请求到底会经历哪些步骤呢？</p>
</blockquote>
<h3 id="知识点预告">知识点预告</h3>
<p>先上一张整体的流程图：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220413171451070bFSgRzW3Rx0S.png" alt=""></p>
<ul>
<li><strong>集群环境</strong>：如果是 Nacos 集群环境，那么拓扑结构是什么样的。</li>
<li><strong>组装请求</strong>：客户端组装注册请求，下一步对 Nacos 服务发起远程调用。</li>
<li><strong>随机节点</strong>：客户端随机选择集群中的一个 Nacos 节点发起注册，实现负载均衡。</li>
<li><strong>路由转发</strong>：Nacos 节点收到注册请求后，看下是不是属于自己的，不是的话，就进行路由转发。</li>
<li><strong>处理请求</strong>：转发给指定的节点后，该节点就会将注册请求中的实例信息解析出来，存到自定义的内存结构中。</li>
<li><strong>最终一致性</strong>：通过 Nacos 自研的 Distro 协议执行<code dir="auto">延迟异步任务</code>，将注册信息同步给集群中的其他节点，保证了数据的最终一致性。</li>
<li><strong>异步重试</strong>：如果注册失败，客户端将会切换 Nacos 节点，再次发起注册请求，保证高可用性。</li>
</ul>
<p>这些知识点里面还有很多细节，我会通过画图 + 源码剖析的方式给大家解答。如果遇到源码看不太懂的地方，可以多看下我画的图，然后翻下源码，对照着一起看。</p>
<p>小 Tip：本文使用的 Nacos 版本： 2.0.4。</p>
<h2 id="一源头发起注册">一、源头：发起注册</h2>
<h3 id="11-阅读源码的小技巧">1.1 阅读源码的小技巧</h3>
<p>在使用 Nacos 组件的的时候，我们加上一个注解 <code dir="auto">@EnableDiscoveryClient</code> 就可以使服务自动注册到 Nacos。</p>
<blockquote>
<p>那么这个发起注册的地方到底在哪呢？注册信息又是长什么样的呢？</p>
</blockquote>
<p>告诉大家一个看源码的小技巧，拿到源码后，不是直接各个文件都看一篇，而是先看源码中带的 example 文件夹。如下图所示，找到 example 的 App 类，里面就有发起注册的实例代码。如下图所示：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220412071138017zxK9mw.png" alt=""></p>
<p>当然，我们也可以通过官网给的 curl 命令发起 HTTP 请求：</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.t1efu.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">curl</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-X</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">POST</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080'</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -X POST &#x27;http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080&#x27;"><div></div></button></div></figure></div>
<p><strong>留个问题</strong>：我们都是加一个 Nacos 注解 <code dir="auto">@EnableDiscoveryClient</code>，就会自动把服务实例注册到 Nacos，这个是怎么做到的？</p>
<h3 id="12-发起注册的流程图">1.2 发起注册的流程图</h3>
<p>先来看一下代码的流程图：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220412071400192DVNL4d.png" alt=""></p>
<p>跟着这个流程图，我们 debug 来看下。</p>
<h3 id="13-组装注册的实例信息">1.3 组装注册的实例信息</h3>
<p>入口的核心代码如下图所示，它会组装注册的<code dir="auto">实例信息</code>，放到一个 instance 变量里面：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-202204111612410590Vmd01.png" alt=""></p>
<p>通过代码调试，我们可以看到里面的实例信息长这样：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220411160413112vLIk1i.png" alt=""></p>
<h3 id="14-组装注册请求-request">1.4 组装注册请求 request</h3>
<p>发起注册的核心方法是 doRegisterService()，组装的 request 如下图所示，里面有之前组装的实例信息 instance，还有指定的  namespace（Nacos 的命名空间）、serviceName（服务名），groupName（Nacos 的分组）。</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-202204111623226683NnG6U.png" alt="image-20220411162322668"></p>
<h3 id="15-发起远程调用">1.5 发起远程调用</h3>
<p>requestToServer() 方法里面会调用 RpcClient 的 request() 方法：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">response </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.currentConnection.</span><span style="--0:#B392F0">request</span><span style="--0:#E1E4E8">(request, timeoutMills);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="response = this.currentConnection.request(request, timeoutMills);"><div></div></button></div></figure></div>
<p>就是向 Nacos 发起远程调用，如果是 Nacos 集群，则是向集群中的某个 Nacos 节点发起远程调用。</p>
<p>接下来我们看下客户端是如何选择一个 Nacos 节点进行注册的。</p>
<h2 id="二集群环境分布式的前提">二、集群环境：分布式的前提</h2>
<p>如果是 Nacos 集群环境，客户端会随机选择一个 Nacos 节点发起注册。</p>
<h3 id="21-搭建好一套nacos-集群环境">2.1 搭建好一套Nacos 集群环境</h3>
<p>为了讲解客户端是如何注册到 Nacos 集群环境的底层原理，我在本地搭建了一个 Nacos 集群环境，有 3 个 Nacos 服务，它们的 IP 相同，端口号不同。</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">192.168.10.197:8848</span></div><div class="ec-line"><span style="--0:#B392F0">192.168.10.197:8858</span></div><div class="ec-line"><span style="--0:#B392F0">192.168.10.197:8868</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="192.168.10.197:8848192.168.10.197:8858192.168.10.197:8868"><div></div></button></div></figure></div>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220408100844549MpxWbbx40la1.png" alt=""></p>
<p>然后<strong>服务 A 和服务 B 都是配置了 Nacos 集群</strong>的 IP 和 端口号的，配置如下所示</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">spring.cloud.nacos.discovery.server</span><span style="--0:#F97583">-</span><span style="--0:#E1E4E8">addr</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">=</span><span style="--0:#79B8FF">192.168</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">10</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">197</span><span style="--0:#F97583">:</span><span style="--0:#79B8FF">8848</span><span style="--0:#E1E4E8">,</span><span style="--0:#79B8FF">192.168</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">10</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">197</span><span style="--0:#F97583">:</span><span style="--0:#79B8FF">8858</span><span style="--0:#E1E4E8">,</span><span style="--0:#79B8FF">192.168</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">10</span><span style="--0:#E1E4E8">.</span><span style="--0:#FDAEB7;--0fs:italic">197</span><span style="--0:#F97583">:</span><span style="--0:#79B8FF">8868</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="spring.cloud.nacos.discovery.server-addr  =192.168.10.197:8848,192.168.10.197:8858,192.168.10.197:8868"><div></div></button></div></figure></div>
<p>整体的结构如下图所示，服务 A 和 服务 B 都往 Nacos 集群进行注册。</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220408101723181kPWAUaDBK5jL.png" alt=""></p>
<p><strong>但是里面有一个问题</strong>：服务 A 注册时，是向所有 Nacos 节点发起注册呢？还是只向其中一个节点发起注册？如果只向一个节点注册，要向哪个节点注册呢？</p>
<blockquote>
<p>答案：在 Client 发起注册之前，会有一个后台线程随机拿到 Nacos 集群服务列表中的一个地址。</p>
</blockquote>
<p><strong>Nacos 为什么会这样设计？</strong></p>
<ul>
<li>这其实就是一个负载均衡的思想在里面，每个节点都均匀的分摊请求。</li>
<li>保证高可用，当某个节点宕机后，重新拿到其他的 Nacos 节点来建立连接。</li>
</ul>
<p>接下来我们看下服务 A 是怎么随机拿到一个 Nacos 节点的。</p>
<h2 id="三随机节点平等的世界">三、随机节点：平等的世界</h2>
<p>我们来看下客户端是如何随机选择一个节点的，流程图如下：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220412085821355AZgLcJ.png" alt=""></p>
<p>那么如何找到这些代码逻辑呢？思路是怎么样的？</p>
<p>我们之前讲过，RpcClient 会发起 request 请求，用的是和 Nacos 建立 <code dir="auto">currentConnection</code> 连接来发起调用，代码如下：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">// 发起调用</span></div><div class="ec-line"><span style="--0:#E1E4E8">response </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.currentConnection.</span><span style="--0:#B392F0">request</span><span style="--0:#E1E4E8">(request, timeoutMills);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 发起调用response = this.currentConnection.request(request, timeoutMills);"><div></div></button></div></figure></div>
<p>这个 <code dir="auto">currentConnection</code> 是客户端和 Nacos 集群中的某个节点建立的连接，我们找下它在哪里赋值的。代码如下：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">// 拿到 Nacos 节点信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">serverInfo </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> recommendServer.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">==</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">?</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">nextRpcServer</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> recommendServer.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#99A0A6">// 连接 Nacos 节点</span></div><div class="ec-line"><span style="--0:#E1E4E8">connectToServer </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">connectToServer</span><span style="--0:#E1E4E8">(serverInfo);</span></div><div class="ec-line"><span style="--0:#99A0A6">// 赋值 currentConnection</span></div><div class="ec-line"><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.currentConnection </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> connectToServer;</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 拿到 Nacos 节点信息serverInfo = recommendServer.get() == null ? nextRpcServer() : recommendServer.get();// 连接 Nacos 节点connectToServer = connectToServer(serverInfo);// 赋值 currentConnectionthis.currentConnection = connectToServer;"><div></div></button></div></figure></div>
<p>而连接的信息是通过参数 serverInfo 传进去的，所以我们再看下 serverInfo 在哪里赋值的。</p>
<p>这个 nextRpcServer() 方法里面会<strong>拿到一个随机的 Nacos 地址</strong>：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">// 一个 int 随机数，范围 [0 ~ Nacos 个数)</span></div><div class="ec-line"><span style="--0:#E1E4E8">currentIndex.</span><span style="--0:#B392F0">set</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Random</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">nextInt</span><span style="--0:#E1E4E8">(serverList.</span><span style="--0:#B392F0">size</span><span style="--0:#E1E4E8">()));</span></div><div class="ec-line"><span style="--0:#99A0A6">// index 自增 1</span></div><div class="ec-line"><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> index </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> currentIndex.</span><span style="--0:#B392F0">incrementAndGet</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">%</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">getServerList</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">size</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#99A0A6">// 返回 Nacos 地址</span></div><div class="ec-line"><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">getServerList</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">(index);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 一个 int 随机数，范围 [0 ~ Nacos 个数)currentIndex.set(new Random().nextInt(serverList.size()));// index 自增 1int index = currentIndex.incrementAndGet() % getServerList().size();// 返回 Nacos 地址return getServerList().get(index);"><div></div></button></div></figure></div>
<p><strong>小结</strong>：客户端生成一个随机数，然后通过这个随机数从 Nacos 服务列表中拿到一个 Nacos 服务地址返回给客户端，然后客户端通过这个地址和 Nacos 服务建立连接。Nacos 服务列表中的节点都是平等的，随机拿到的任何一个节点都是可以用来发起调用的。</p>
<h2 id="四路由转发不是我的菜">四、路由转发：不是我的菜</h2>
<h3 id="41-发起和转发请求的流程">4.1 发起和转发请求的流程</h3>
<p>为了演示发起注册的流程，我在这里模拟了一个注册请求。</p>
<p>用的是 curl 命令，对 Nacos 节点（127.0.0.1:8848）发起注册请求：</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">curl</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-X</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">POST</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080'</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -X POST &#x27;http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080&#x27;"><div></div></button></div></figure></div>
<p><strong>请求 URL</strong>：/nacos/v1/ns/instance</p>
<p><strong>请求参数</strong>：</p>
<ul>
<li>serviceName=nacos.naming.serviceName</li>
<li>ip=20.18.7.11</li>
<li>port=8080’</li>
</ul>
<p>之前我们讲到，Nacos 的有多个节点可以分别处理请求，当节点发现这个请求不是属于自己的，就会进行转发。</p>
<p>如下图所示：</p>
<p>服务 A 随机选择一个 Nacos 节点（图中为 Nacos1）发起注册请求，请求参数中包含了实例信息，Nacos 1 根据实例信息 hash + 取模拿到正确的节点，如果不属于自己，则将请求转发给其他节点（图中为 Nacos2）</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220412215250738gU1BYV.png" alt=""></p>
<p>那么路由转发的细节是怎么样的？这个就涉及到 Distro 协议了，我们接着往下看。</p>
<h3 id="41-路由转发的逻辑">4.1 路由转发的逻辑</h3>
<p>其实 Nacos 节点的路由转发逻辑比较简单，先来看下流程图：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220412184102530MvbD7W.png" alt=""></p>
<p>步骤如下：</p>
<ul>
<li>①  Nacos 节点从客户端发起的 request 中拿到客户端的实例信息生成 distroTag，如 IP + port 或 service name。</li>
<li>②  Nacos 根据 distroTag 生成 hash 值。</li>
<li>③  用 hash 值对 Nacos 节点数进行<code dir="auto">取余</code>，拿到余数，比如 0、1、2、3。</li>
<li>④ 根据余数从 Nacos 节点列表中拿到指定的节点地址。</li>
</ul>
<p><strong>我没看懂的点</strong>：我这里启动了三个 Nacos 节点，如下图所示的 三个 Running 节点。但是为什么 Nacos 的 ServersList 会多了一个 192.168.10.197:8848的节点？</p>
<blockquote>
<p>开发者回答：
nacos-server存在一个机制，在启动的时候会检查cluster.conf中配置的member内容，如果发现自身不在member列表中，就会将自身地址加入到member列表中。
图中member显示有127.0.0.1的3个节点和一个192.168.10.197节点，说明nacos-server获取到的ip是192.168.10.197，但是cluster.conf中配置的ip是127.0.0.1。
需要解决的话有两种方法，一种是严格按照上文中的配置，配置ip为192.168.10.197，另一种方式是在启动服务是设置JVM参数-Dnacos.server.ip=127.0.0.1
这个配置错误同样常见于使用K8S搭建Nacos集群，域名和hostname互相混用时出现。</p>
</blockquote>
<p><img src="/img/blog/nacos-reigster-mechanism/image-202204122033417675s0J4F.png" alt="IDEA 启动了三个 nacos 节点"></p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220413153431838s2Wj4W.png" alt="nacos 控制台有四个节点"></p>
<h3 id="42-路由转发源码分析">4.2 路由转发源码分析</h3>
<p>入口文件是 DistroFilter.java：</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">naming/src/main/java/com/alibaba/nacos/naming/web/DistroFilter.java</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="naming/src/main/java/com/alibaba/nacos/naming/web/DistroFilter.java"><div></div></button></div></figure></div>
<p>请求会先到 DistroFilter 类的 doFilter() 方法，拿到正确的节点地址后，将请求转发出去。</p>
<p>获取需要转发节点地址的代码如下：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">// 找到 Nacos 集群中的目标节点</span></div><div class="ec-line"><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String targetServer </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> distroMapper.</span><span style="--0:#B392F0">mapSrv</span><span style="--0:#E1E4E8">(distroTag);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">// mapSrv 方法会先 hash，然后再取模，responsibleTag的值类似这样："20.18.7.11:8080"</span></div><div class="ec-line"><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> index </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">distroHash</span><span style="--0:#E1E4E8">(responsibleTag) </span><span style="--0:#F97583">%</span><span style="--0:#E1E4E8"> servers.</span><span style="--0:#B392F0">size</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">// distroHash 方法里面会对 客户端的 ip+port 字符串或者服务名字符串 进行 hash</span></div><div class="ec-line"><span style="--0:#E1E4E8">Math.</span><span style="--0:#B392F0">abs</span><span style="--0:#E1E4E8">(responsibleTag.</span><span style="--0:#B392F0">hashCode</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">%</span><span style="--0:#E1E4E8"> Integer.MAX_VALUE);</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 找到 Nacos 集群中的目标节点final String targetServer = distroMapper.mapSrv(distroTag);// mapSrv 方法会先 hash，然后再取模，responsibleTag的值类似这样：&#x22;20.18.7.11:8080&#x22;int index = distroHash(responsibleTag) % servers.size();// distroHash 方法里面会对 客户端的 ip+port 字符串或者服务名字符串 进行 hashMath.abs(responsibleTag.hashCode() % Integer.MAX_VALUE);"><div></div></button></div></figure></div>
<p>不论是自己处理注册请求还是转发给其他节点来处理，都会把实例信息存储起来，那么是如何进行存储的？</p>
<h2 id="五处理请求快到碗里来">五、处理请求：快到碗里来</h2>
<p>Nacos 目前有两个版本，v1 和 v2，如果是 v1，则是 instanceController 来处理注册请求，否则用 instanceControllerV2。本篇我们只讲解 v1 版本是怎么处理请求的。</p>
<p>先上流程图：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220413164932907KHTvVM.png" alt="添加实例信息的流程"></p>
<p>测试用的发起注册的命令：</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">curl</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-X</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">POST</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">'http://127.0.0.1:8858/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080'</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -X POST &#x27;http://127.0.0.1:8858/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&#x26;ip=20.18.7.11&#x26;port=8080&#x27;"><div></div></button></div></figure></div>
<p>核心代码就是这个：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220413160148289ylcS1n.png" alt="服务端注册实例的方法"></p>
<p>有一个 synchronized 锁，将临时的实例信息存放起来，所以重点看下 这个 consistencyService.put() 方法做了什么事情。</p>
<p>先看下源码：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">onPut</span><span style="--0:#E1E4E8">(key, value);</span></div><div class="ec-line"><span style="--0:#99A0A6">// 开启 1s 的延迟任务，将数据同步给其他 Nacos 节点</span></div><div class="ec-line"><span style="--0:#E1E4E8">distroProtocol.</span><span style="--0:#B392F0">sync</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8">      </span><span style="--0:#B392F0">DistroKey</span><span style="--0:#E1E4E8">(key,KeyBuilder.INSTANCE_LIST_KEY_PREFIX),DataOperation.CHANGE,</span></div><div class="ec-line"><span style="--0:#E1E4E8">                DistroConfig.</span><span style="--0:#B392F0">getInstance</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">getSyncDelayMillis</span><span style="--0:#E1E4E8">());</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="onPut(key, value);// 开启 1s 的延迟任务，将数据同步给其他 Nacos 节点distroProtocol.sync(new      DistroKey(key,KeyBuilder.INSTANCE_LIST_KEY_PREFIX),DataOperation.CHANGE,                DistroConfig.getInstance().getSyncDelayMillis());"><div></div></button></div></figure></div>
<p>这里面做了三件事情：</p>
<ul>
<li>① 将实例信息存放到内存缓存 concurrentHashMap 里面。</li>
<li>② 添加一个任务到 BlockingQueue 里面，这个任务就是将最新的实例列表通过 UDP 的方式推送给所有客户端（服务实例），这样客户端就拿到了最新的服务实例列表。</li>
<li>③ 开启 1s 的延迟任务，将数据通过给其他 Nacos 节点。</li>
</ul>
<p><strong>注意</strong>：针对第二点和第三点，属于 Distro 一致性协议的一部分，里面的内容还比较多，我们放到下一讲专门来讲。</p>
<p><strong>知识点预告</strong>：</p>
<ul>
<li>
<p>这里的存储实例和同步的方式和 Eureka 有什么区别？Eureka 用的三层缓存架构，Nacos 用的 CopyOnWrite 技术。</p>
</li>
<li>
<p>如何推送给所有客户端的？UDP 方式。</p>
</li>
<li>
<p>如何同步给 Nacos 其他节点的？Distro 一致性协议。</p>
</li>
</ul>
<h2 id="六总结">六、总结</h2>
<p>本文通过发起一条注册请求，讲解了 Nacos 客户端如何随机选择节点、Nacos Server 如何路由、Nacos Server 如何存储注册实例。</p>
<p><strong>核心流程</strong>：</p>
<p><img src="/img/blog/nacos-reigster-mechanism/image-20220413171451070bFSgRz-20220530201153679.png" alt=""></p>  </div> </div>  </div> <div class="inline-block w-[30%] fixed bg-gray-14 h-full"> <aside> <div class="nav myroot prose"><ul>
<li>
<p><a href="#nacos-%E7%9A%84%E4%B8%80%E6%9D%A1%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82%E4%BC%9A%E7%BB%8F%E5%8E%86%E4%BB%80%E4%B9%88">Nacos 的一条注册请求会经历什么？</a></p>
</li>
<li>
<p><a href="#%E5%89%8D%E8%A8%80">前言</a></p>
<ul>
<li>
<ul>
<li><a href="#%E7%9F%A5%E8%AF%86%E7%82%B9%E9%A2%84%E5%91%8A">知识点预告</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%B8%80%E6%BA%90%E5%A4%B4%E5%8F%91%E8%B5%B7%E6%B3%A8%E5%86%8C">一、源头：发起注册</a></p>
<ul>
<li><a href="#11-%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7">1.1 阅读源码的小技巧</a></li>
<li><a href="#12-%E5%8F%91%E8%B5%B7%E6%B3%A8%E5%86%8C%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE">1.2 发起注册的流程图</a></li>
<li><a href="#13-%E7%BB%84%E8%A3%85%E6%B3%A8%E5%86%8C%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%BF%A1%E6%81%AF">1.3 组装注册的实例信息</a></li>
<li><a href="#14-%E7%BB%84%E8%A3%85%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82-request">1.4 组装注册请求 request</a></li>
<li><a href="#15-%E5%8F%91%E8%B5%B7%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8">1.5 发起远程调用</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%BA%8C%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%89%8D%E6%8F%90">二、集群环境：分布式的前提</a></p>
<ul>
<li><a href="#21-%E6%90%AD%E5%BB%BA%E5%A5%BD%E4%B8%80%E5%A5%97nacos-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83">2.1 搭建好一套Nacos 集群环境</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%B8%89%E9%9A%8F%E6%9C%BA%E8%8A%82%E7%82%B9%E5%B9%B3%E7%AD%89%E7%9A%84%E4%B8%96%E7%95%8C">三、随机节点：平等的世界</a></p>
</li>
<li>
<p><a href="#%E5%9B%9B%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91%E4%B8%8D%E6%98%AF%E6%88%91%E7%9A%84%E8%8F%9C">四、路由转发：不是我的菜</a></p>
<ul>
<li><a href="#41-%E5%8F%91%E8%B5%B7%E5%92%8C%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B5%81%E7%A8%8B">4.1 发起和转发请求的流程</a></li>
<li><a href="#41-%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91%E7%9A%84%E9%80%BB%E8%BE%91">4.1 路由转发的逻辑</a></li>
<li><a href="#42-%E8%B7%AF%E7%94%B1%E8%BD%AC%E5%8F%91%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">4.2 路由转发源码分析</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%BA%94%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E5%BF%AB%E5%88%B0%E7%A2%97%E9%87%8C%E6%9D%A5">五、处理请求：快到碗里来</a></p>
</li>
<li>
<p><a href="#%E5%85%AD%E6%80%BB%E7%BB%93">六、总结</a></p>
</li>
</ul>
</li>
</ul></div> </aside> </div> </div>   </body> </html>