<!DOCTYPE html><html lang="en" data-theme="light" class="astro-37fxchfa"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="referrer" content="no-referrer"><meta name="generator" content="Astro v3.6.0"><title>Nacos Blog</title><style>.sl-markdown-content :not(h1,h2,h3,h4,h5,h6)+:is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){margin-top:2.5rem;scroll-margin-top:4rem}.sl-markdown-content li+li:not(:where(.not-content *)),.sl-markdown-content dt+dt:not(:where(.not-content *)),.sl-markdown-content dt+dd:not(:where(.not-content *)),.sl-markdown-content dd+dd:not(:where(.not-content *)){margin-top:.25rem}.sl-markdown-content li>:last-child:not(li,ul,ol):not(a,strong,em,del,span,input,:where(.not-content *)){margin-bottom:1.25rem}.sl-markdown-content dt:not(:where(.not-content *)){font-weight:700}.sl-markdown-content dd:not(:where(.not-content *)){padding-inline-start:1rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){color:#f4f4f6;line-height:var(--sl-line-height-headings);font-weight:600}.sl-markdown-content :is(img,picture,video,canvas,svg,iframe):not(:where(.not-content *)){display:block;max-width:100%;height:auto}.sl-markdown-content h1:not(:where(.not-content *)){font-size:var(--sl-text-h1)}.sl-markdown-content h2:not(:where(.not-content *)){font-size:var(--sl-text-h2)}.sl-markdown-content h3:not(:where(.not-content *)){font-size:var(--sl-text-h3)}.sl-markdown-content h4:not(:where(.not-content *)){font-size:var(--sl-text-h4)}.sl-markdown-content h5:not(:where(.not-content *)){font-size:var(--sl-text-h5)}.sl-markdown-content h6:not(:where(.not-content *)){font-size:var(--sl-text-h6)}.sl-markdown-content a:not(:where(.not-content *)){color:var(--sl-color-text-accent)}.sl-markdown-content a:hover:not(:where(.not-content *)){color:var(--sl-color-white)}.sl-markdown-content code:not(:where(.not-content *)){background-color:var(--sl-color-bg-inline-code);margin-block:-.125rem;padding:.125rem .375rem;font-size:var(--sl-text-code-sm)}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) code{font-size:inherit}.sl-markdown-content pre:not(:where(.not-content *)){border:1px solid var(--sl-color-gray-5);padding:.75rem 1rem;font-size:var(--sl-text-code);-moz-tab-size:2;-o-tab-size:2;tab-size:2}.sl-markdown-content pre code:not(:where(.not-content *)){all:unset;font-family:var(--__sl-font-mono)}.sl-markdown-content blockquote:not(:where(.not-content *)){border-inline-start:1px solid var(--sl-color-gray-5);padding-inline-start:1rem}.sl-markdown-content table:not(:where(.not-content *)){display:block;overflow:auto;border-collapse:collapse}.sl-markdown-content tr:nth-child(2n):not(:where(.not-content *)){background-color:var(--sl-color-gray-7, var(--sl-color-gray-6))}.sl-markdown-content :is(th,td):not(:where(.not-content *)){border:1px solid var(--sl-color-hairline-light);padding:.375rem .8125rem}.sl-markdown-content hr:not(:where(.not-content *)){border:0;border-bottom:1px solid var(--sl-color-hairline)}.sl-markdown-content h2{line-height:3.5rem}main:where(.astro-bvzihdzo){width:calc(100% - 2em);max-width:100%;margin:0}.hero-image:where(.astro-bvzihdzo){width:100%}.hero-image:where(.astro-bvzihdzo) img:where(.astro-bvzihdzo){display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.nacos-prose:where(.astro-bvzihdzo){width:90%;padding:1em;color:rgb(var(--gray-dark))}.title:where(.astro-bvzihdzo){margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title:where(.astro-bvzihdzo) h1:where(.astro-bvzihdzo){margin:0 0 .5em}.date:where(.astro-bvzihdzo){margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on:where(.astro-bvzihdzo){font-style:italic}
</style>
<link rel="stylesheet" href="/_astro/index.a492c6fc.css" />
<style>@media (max-width: 36rem){html{font-size:12px}}
</style><script type="module" src="/_astro/hoisted.a3604078.js"></script></head> <body class="astro-37fxchfa"> <header-layout class="header bg-gray-14 relative astro-3ef6ksr2" style="position: sticky; height: 4rem"> <div data-modal-panel class="modal-panel hidden h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2"></div> <div style="height: 4rem" class="nav bg-gray-14 relative top-0 right-0 bottom-0 left-0 flex items-center justify-between astro-3ef6ksr2"> <!-- logo --> <a href="/" class="astro-3ef6ksr2"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png"> </a> <!-- 菜单 --> <div class="pc_nav_menu flex h-full items-center astro-3ef6ksr2"> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-docs class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">DOCS</span> <svg data-docs-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2"></path> </svg> </div> <div data-docs-dropdown style="top: 4rem" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 astro-3ef6ksr2"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">Documentation</span> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <span class="text-sm text-gray-02 astro-3ef6ksr2">1.x</span> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <span class="text-sm text-gray-02 astro-3ef6ksr2">2.x</span> </a> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-nacos-cloud class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">NACOS CLOUD</span> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-community class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">COMMUNITY</span> <svg data-community-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2"></path> </svg> </div> <div data-community-dropdown style="top: 4rem" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 z-50 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 justify-center astro-3ef6ksr2"> <div class="flex mr-32 astro-3ef6ksr2"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">COMMUNITY</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Contact</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Report</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Contribute</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Stars</a> </div> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2">EVENTS</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Events</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">News</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/">Meetup</a> <span class="text-xs text-gray-10 mb-2 mt-10 astro-3ef6ksr2">Resources</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/blog">Blog</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/docs/ebook/iez8a4">E-book</a> </div> </div> <div class="flex astro-3ef6ksr2"> <div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2"> <img class=" astro-3ef6ksr2" src="/left-shortcut.png"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2">Key to service-centric (for example microservice or cloud-native) architectures.</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2">READ ARTICLE</button> </div><div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2"> <img class=" astro-3ef6ksr2" src="/right-shortcut.png"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2">An easy-to-use platform for building cloud native applications</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2">READ ARTICLE</button> </div> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2"> <div data-demo class="h-full flex items-center p-0.5 astro-3ef6ksr2"> <span class="title astro-3ef6ksr2">DEMO</span> </div> </div> </div> <!-- 右侧菜单 --> <div class="astro-3ef6ksr2">  </div> <!-- 小屏适配 --> <div class="mobile_nav_menu hidden cursor-pointer astro-3ef6ksr2"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2"> <svg class="cursor-pointer icon ml-8 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6304" width="24" height="24"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 479.169H438.553c-17.673 0-32 14.327-32 32s14.327 32 32 32h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM319.028 351.594l-160 160 160 160z" fill="#f4f4f6" p-id="6305" class="astro-3ef6ksr2"></path></svg> </button> </div> <!-- 移动端导航菜单 --> <div data-mobile-menu class="overflow-hidden hidden flex flex-col w-screen bg-gray-01 h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2"> <!-- 顶部logo --> <div style="height: 4rem" class="bg-gray-14 px-8 flex items-center justify-start astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png"> </a> <div class="menu_close flex items-center cursor-pointer astro-3ef6ksr2"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2"> <svg class="cursor-pointer icon ml-8 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7494" id="mx_n_1702523741163" width="24" height="24"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM192.028 543.17h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.028c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM705.162 671.594l160-160-160-160z" fill="#f4f4f6" p-id="7495" class="astro-3ef6ksr2"></path></svg> </button> </div> </div> <div data-mobile-menu-list class="w-full pl-8 astro-3ef6ksr2"> <ul class="list-none pl-0 astro-3ef6ksr2"> <li class="astro-3ef6ksr2"> <div mobile-menu-expand-docs class="astro-3ef6ksr2"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2">DOCS</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2"></path></svg> </button> </div> <div mobile-menu-expand-content-docs class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2"> <div mobile-menu-fold-docs class="flex items-center pt-8 pb-4 astro-3ef6ksr2"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2">DOCS</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2"></div> <div class="astro-3ef6ksr2"> <span class="text-xs text-gray-12 astro-3ef6ksr2">Documentation</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <li class="text-sm text-gray-14 astro-3ef6ksr2">1.x</li> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2"> <li class="text-sm text-gray-14 astro-3ef6ksr2">2.x</li> </a> </ul> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2"> <a href="/nacosCloud" class="text-gray-14 text-sm astro-3ef6ksr2">NACOS CLOUD</a> </li> <li class="astro-3ef6ksr2"> <div mobile-menu-expand-com class="astro-3ef6ksr2"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2">COMMUNITY</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2"></path></svg> </button> </div> <div mobile-menu-expand-content-com class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2"> <div mobile-menu-fold-com class="flex items-center pt-8 pb-4 astro-3ef6ksr2"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2">COMMUNITY</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2"></div> <div class="mobile_menu_community flex justify-between astro-3ef6ksr2"> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">COMMUNITY</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Contact </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Report </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Contribute </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Stars </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">EVENTS</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Events </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> News </li> </a><a href="/" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Meetup </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2"> <span class="text-xs text-gray-7 astro-3ef6ksr2">Resources</span> <ul class="pl-0 list-none astro-3ef6ksr2"> <a href="/blog" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> Blog </li> </a><a href="/docs/ebook/iez8a4" class="astro-3ef6ksr2"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2"> E-book </li> </a> </ul> </div> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2"> <a href="/" class="text-gray-14 text-sm astro-3ef6ksr2">DEMO</a> </li> </ul> </div> </div> </div> </header-layout>    <div class="bg-gray-14 "> <div class="w-[70%] inline-block"> <div class="sl-markdown-content bg-gray-14 text-gray-01 astro-bvzihdzo"> <div class="hero-image  astro-bvzihdzo">  </div> <div class="nacos-prose mx-auto astro-bvzihdzo"> <div class="title astro-bvzihdzo"> <div class="date astro-bvzihdzo"> February 12, 2020  </div> <h1 class="astro-bvzihdzo">Nacos 1.3.0 全新内核构建过程</h1> <hr class="astro-bvzihdzo"> </div>  <h1 id="nacos-130-特性以及功能使用文档">Nacos 1.3.0 特性以及功能使用文档</h1>
<p><a name="0YIG0"></a></p>
<h2 id="概述">概述</h2>
<p>本次1.3.0的改动程度很大，涉及两大模块的修改以及新增一个核心模块</p>
<ol>
<li>nacos-core模块修改
<ol>
<li>nacos集群节点成员寻址模式的统一管理</li>
<li>nacos内部事件机制</li>
<li>nacos一致性协议层</li>
</ol>
</li>
<li>nacos-config模块修改
<ol>
<li>新增内嵌分布式数据存储组件</li>
<li>内嵌存储与外置存储细分</li>
<li>内嵌存储简单运维</li>
</ol>
</li>
<li>nacos-consistency模块新增
<ol>
<li>对于AP协议以及CP协议的统一抽象</li>
</ol>
</li>
</ol>
<br>
<p><a name="rnkDY"></a></p>
<h2 id="系统参数变化">系统参数变化</h2>
<p><a name="1Gmg9"></a></p>
<h3 id="新增">新增</h3>



































<table><thead><tr><th align="center"><strong>core模块</strong></th><th>nacos.watch-file.max-dirs</th><th>JVM参数</th><th>最大可监听目录数量</th></tr></thead><tbody><tr><td align="center"></td><td>nacos.core.notify.ring-buffer-size</td><td>JVM参数</td><td>快速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.notify.share-buffer-size</td><td>JVM参数</td><td>慢速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.member.fail-access-cnt</td><td>JVM参数、application.properties配置</td><td>集群成员节点最大失败访问次数</td></tr><tr><td align="center"></td><td>nacos.core.address-server.retry</td><td>JVM参数、application.properties配置</td><td>地址服务器寻址模式，首次启动请求重试次数</td></tr></tbody></table>
<br>
<p><a name="kxo8O"></a></p>
<h2 id="nacos的未来整体逻辑架构及其组件">Nacos的未来整体逻辑架构及其组件</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&#x26;display=inline&#x26;height=1184&#x26;margin=%5Bobject%20Object%5D&#x26;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&#x26;originHeight=1184&#x26;originWidth=1608&#x26;size=279074&#x26;status=done&#x26;style=none&#x26;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png"></p>
<p><a name="Hyc6u"></a></p>
<h2 id="nacos集群成员节点寻址模式">Nacos集群成员节点寻址模式</h2>
<p><br>在1.3.0之前，nacos的naming模块以及config模块存在各自的集群成员节点列表管理任务。为了统一nacos集群下成员列表的寻址模式，将集群节点管理的实现从naming模块以及config模块剥离出来，统一下沉到了core模块的寻址模，同时新增命令行参数 **-Dnacos.member.list **进行设置nacos集群节点列表，该参数可以看作是cluster.conf文件的一个替代。目前nacos的寻址模式类别如下</p>
<ol>
<li>单机模式下：StandaloneMemberLookup</li>
<li>集群模式
<ol>
<li>cluster.conf文件存在：FileConfigMemberLookup</li>
<li>cluster.conf文件不存在或者 -Dnacos.member.list没有设置：AddressServerMemberLookup</li>
</ol>
</li>
</ol>
<p>如果说想指定某一种寻址模式，则设置此参数：<strong>nacos.core.member.lookup.type=[file,address-server]</strong></p>
<p>逻辑图如下
<img src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""></p>
<p><a name="wqkMp"></a></p>
<h3 id="寻址模式详细">寻址模式详细</h3>
<p>接下来介绍除了单机模式下的寻址模式的其他两种寻址模式<br></p>
<p><a name="egl3H"></a></p>
<h4 id="fileconfigmemberlookup">FileConfigMemberLookup</h4>
<p>该寻址模式是基于cluster.conf文件进行管理的，每个节点会读取各自${nacos.home}/conf下的cluster.conf文件内的成员节点列表，然后组成一个集群。并且在首次读取完${nacos.home}/conf下的cluster.conf文件后，会自动向操作系统的_<strong>inotify</strong>_机制注册一个目录监听器，监听${nacos.home}/conf目录下的所有文件变动（注意，这里只会监听文件，对于子目录下的文件变动无法监听）<br>当需要进行集群节点扩缩容时，需要手动去修改每个节点各自${nacos.home}/conf下的cluster.conf的成员节点列表内容。</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.t1efu.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> FileWatcher watcher </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">FileWatcher</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onChange</span><span style="--0:#E1E4E8">(FileChangeEvent </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#B392F0">readClusterConfFromDisk</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">interest</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">context</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> StringUtils.</span><span style="--0:#B392F0">contains</span><span style="--0:#E1E4E8">(context, </span><span style="--0:#9ECBFF">"cluster.conf"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">};</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#B392F0">readClusterConfFromDisk</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (memberManager.</span><span style="--0:#B392F0">getServerList</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">isEmpty</span><span style="--0:#E1E4E8">()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosException</span><span style="--0:#E1E4E8">(NacosException.SERVER_ERROR,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#9ECBFF">"Failed to initialize the member node, is empty"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// Use the inotify mechanism to monitor file changes and automatically</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// trigger the reading of cluster.conf</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    WatchFileCenter.</span><span style="--0:#B392F0">registerWatcher</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getConfFilePath</span><span style="--0:#E1E4E8">(), watcher);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">catch</span><span style="--0:#E1E4E8"> (Throwable </span><span style="--0:#FFAB70">e</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.CLUSTER.</span><span style="--0:#B392F0">error</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"An exception occurred in the launch file monitor : {}"</span><span style="--0:#E1E4E8">, e);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private FileWatcher watcher = new FileWatcher() {    @Override    public void onChange(FileChangeEvent event) {      readClusterConfFromDisk();    }    @Override    public boolean interest(String context) {      return StringUtils.contains(context, &#x22;cluster.conf&#x22;);    }};@Overridepublic void start() throws NacosException {  readClusterConfFromDisk();  if (memberManager.getServerList().isEmpty()) {    throw new NacosException(NacosException.SERVER_ERROR,          &#x22;Failed to initialize the member node, is empty&#x22;);  }  // Use the inotify mechanism to monitor file changes and automatically  // trigger the reading of cluster.conf  try {    WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);  }  catch (Throwable e) {    Loggers.CLUSTER.error(&#x22;An exception occurred in the launch file monitor : {}&#x22;, e);  }}"><div></div></button></div></figure></div>
<p>首次启动时直接读取cluster.conf文件内的节点列表信息，然后向WatchFileCenter注册一个目录监听器，当cluster.conf文件发生变动时自动触发_<strong>readClusterConfFromDisk()</strong>_重新读取cluster.conf文件<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014354207-49c1e934-2aa5-465a-8a2b-0b09902814f8.png#align=left&#x26;display=inline&#x26;height=531&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=531&#x26;originWidth=1169&#x26;size=105696&#x26;status=done&#x26;style=none&#x26;width=1169" alt="image.png"></p>
<p><a name="yFTCl"></a></p>
<h4 id="addressservermemberlookup">AddressServerMemberLookup</h4>
<p>该寻址模式是基于一个额外的web服务器来管理cluster.conf，每个节点定期向该web服务器请求cluster.conf的文件内容，然后实现集群节点间的寻址，以及扩缩容。<br>当需要进行集群扩缩容时，只需要修改cluster.conf文件即可，然后每个节点向地址服务器请求时会自动的得到最新的cluster.conf文件内容。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (start.</span><span style="--0:#B392F0">compareAndSet</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">, </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.maxFailCount </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> Integer.</span><span style="--0:#B392F0">parseInt</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"maxHealthCheckFailCount"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"12"</span><span style="--0:#E1E4E8">));</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">initAddressSys</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">run</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">initAddressSys</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  String envDomainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getenv</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address_server_domain"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(envDomainName)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    domainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.domain"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"jmenv.tbsite.net"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  } </span><span style="--0:#F97583">else</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    domainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> envDomainName;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  String envAddressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getenv</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address_server_port"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(envAddressPort)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    addressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.port"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"8080"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  } </span><span style="--0:#F97583">else</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    addressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> envAddressPort;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  addressUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.url"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ApplicationUtils.</span><span style="--0:#B392F0">getContextPath</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"serverlist"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  addressServerUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"http://"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> domainName </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">":"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressUrl;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  envIdUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"http://"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> domainName </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">":"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/env"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  Loggers.CORE.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"ServerListService address-server port:"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  Loggers.CORE.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"ADDRESS_SERVER_URL:"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressServerUrl);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">SuppressWarnings</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"PMD.UndefineMagicConstantRule"</span><span style="--0:#E1E4E8">)</span></div><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">run</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// With the address server, you need to perform a synchronous member node pull at startup</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// Repeat three times, successfully jump out</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> success </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  Throwable ex </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> maxRetry </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> ApplicationUtils.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"nacos.core.address-server.retry"</span><span style="--0:#E1E4E8">, Integer.class, </span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">for</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> i </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">0</span><span style="--0:#E1E4E8">; i </span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8"> maxRetry; i </span><span style="--0:#F97583">++</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#B392F0">syncFromAddressUrl</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">      success </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">break</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    } </span><span style="--0:#F97583">catch</span><span style="--0:#E1E4E8"> (Throwable </span><span style="--0:#FFAB70">e</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      ex </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> e;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      Loggers.CLUSTER.</span><span style="--0:#B392F0">error</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"[serverlist] exception, error : {}"</span><span style="--0:#E1E4E8">, ExceptionUtil.</span><span style="--0:#B392F0">getAllExceptionMsg</span><span style="--0:#E1E4E8">(ex));</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">!</span><span style="--0:#E1E4E8">success) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosException</span><span style="--0:#E1E4E8">(NacosException.SERVER_ERROR, ex);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  GlobalExecutor.</span><span style="--0:#B392F0">scheduleByCommon</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">AddressServerSyncTask</span><span style="--0:#E1E4E8">(), </span><span style="--0:#79B8FF">5_000L</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Overridepublic void start() throws NacosException {  if (start.compareAndSet(false, true)) {    this.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(&#x22;maxHealthCheckFailCount&#x22;, &#x22;12&#x22;));    initAddressSys();    run();  }}private void initAddressSys() {  String envDomainName = System.getenv(&#x22;address_server_domain&#x22;);  if (StringUtils.isBlank(envDomainName)) {    domainName = System.getProperty(&#x22;address.server.domain&#x22;, &#x22;jmenv.tbsite.net&#x22;);  } else {    domainName = envDomainName;  }  String envAddressPort = System.getenv(&#x22;address_server_port&#x22;);  if (StringUtils.isBlank(envAddressPort)) {    addressPort = System.getProperty(&#x22;address.server.port&#x22;, &#x22;8080&#x22;);  } else {    addressPort = envAddressPort;  }  addressUrl = System.getProperty(&#x22;address.server.url&#x22;,        ApplicationUtils.getContextPath() + &#x22;/&#x22; + &#x22;serverlist&#x22;);  addressServerUrl = &#x22;http://&#x22; + domainName + &#x22;:&#x22; + addressPort + addressUrl;  envIdUrl = &#x22;http://&#x22; + domainName + &#x22;:&#x22; + addressPort + &#x22;/env&#x22;;  Loggers.CORE.info(&#x22;ServerListService address-server port:&#x22; + addressPort);  Loggers.CORE.info(&#x22;ADDRESS_SERVER_URL:&#x22; + addressServerUrl);}@SuppressWarnings(&#x22;PMD.UndefineMagicConstantRule&#x22;)private void run() throws NacosException {  // With the address server, you need to perform a synchronous member node pull at startup  // Repeat three times, successfully jump out  boolean success = false;  Throwable ex = null;  int maxRetry = ApplicationUtils.getProperty(&#x22;nacos.core.address-server.retry&#x22;, Integer.class, 5);  for (int i = 0; i < maxRetry; i ++) {    try {      syncFromAddressUrl();      success = true;      break;    } catch (Throwable e) {      ex = e;      Loggers.CLUSTER.error(&#x22;[serverlist] exception, error : {}&#x22;, ExceptionUtil.getAllExceptionMsg(ex));    }  }  if (!success) {    throw new NacosException(NacosException.SERVER_ERROR, ex);  }  GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), 5_000L);}"><div></div></button></div></figure></div>
<p>在初始化时，会主动去向地址服务器同步当前的集群成员列表信息，如果失败则进行重试，其最大重试次数可通过设置_<strong>nacos.core.address-server.retry</strong>_来控制，默认是5次，然后成功之后，将创建定时任务去向地址服务器同步集群成员节点信息<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014362972-004f5338-af0d-4d0d-b769-4f3d5118c08a.png#align=left&#x26;display=inline&#x26;height=846&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=846&#x26;originWidth=1149&#x26;size=188886&#x26;status=done&#x26;style=none&#x26;width=1149" alt="image.png"></p>
<p><a name="sgOTI"></a></p>
<h3 id="节点管理和寻址模式如何结合的">节点管理和寻址模式如何结合的</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014400580-39b83aa0-c548-4241-a49e-0d72abda2a95.png#align=left&#x26;display=inline&#x26;height=715&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=715&#x26;originWidth=1189&#x26;size=131826&#x26;status=done&#x26;style=none&#x26;width=1189" alt="image.png"><br>MemberLookup在启动之后，会根据不同的寻址模式，执行寻址任务，将收集到集群节点列表信息，调用memberChange，触发集群节点变动，然后发布节点变更事件</p>
<p><a name="idHpC"></a></p>
<h2 id="nacos一致性协议协议层抽象">Nacos一致性协议协议层抽象</h2>
<p>从nacos的未来的整体架构图可以看出，一致性协议层将是作为nacos的最为核心的模块，将服务于构建在core模块之上的各个功能模块，或者服务与core模块本身。而一致性协议因为分区容错性的存在，需要在可用性与一致性之间做选择，因此就存在两大类一致性：最终一致性和强一致性。在nacos中，这两类一致性协议都是可能用到的，比如naming模块，对于服务实例的数据管理分别用到了AP以及CP，而对于config模块，将会涉及使用CP。同时还有如下几个功能需求点</p>
<ol>
<li>目前持久化服务使用用了变种版本的raft，并且业务和raft协议耦合，因此需要抽离解耦，同时是选择一个标准的Java版Raft实现</li>
<li>对于中小用户，配置基本其实不会超级多，独立一个mysql，相对重一些，需要一个轻量化的存储方案，并且支持2.0不依赖mysql和3.0依赖mysql可配置能力</li>
<li>由于CP或者AP，其存在多种实现，如何对一致性协议层做一次很好的抽象，以便将来可以快速的实现底层一致性协议具体实现的替换，比如Raft协议，目前nacos的选型是JRaft，不排除将来nacos会自己实现一个标准raft协议或者实现Paxos协议</li>
<li>由于Nacos存在多个独立工作的功能模块，每个功能模块之间不能出现影响，比如A模块处理请求过慢或者出现异常时，不能影响B模块的正常工作，即每个功能模块在使用一致性协议时，如何将每个模块的数据处理进行隔离？</li>
</ol>
<p>根据一致协议以及上述功能需求点，本次做了一个抽象的一致协议层以及相关的接口
<a name="3w8xM"></a></p>
<h3 id="一致协议抽象">一致协议抽象</h3>
<p><a name="p7zRo"></a></p>
<h4 id="consistencyprotocol">ConsistencyProtocol</h4>
<p>所谓一致性，即多个副本之间是否能够保持一致性的特性，而副本的本质就是数据，对数据的操作，不是获取就是修改。同时，一致协议其实是针对分布式情况的，而这必然涉及多个节点，因此，需要有相应的接口能够调整一致性协议的协同工作节点。如果我们要观察一致性协议运行的情况，该怎么办？比如Raft协议，我们希望得知当前集群中的Leader是谁，任期的情况，当前集群中的成员节点有谁？因此，还需要提供一个一致性协议元数据获取。<br>综上所述，ConsistencyProtcol的大致设计可以出来了</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">interface</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ConsistencyProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">T</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Config</span><span style="--0:#E1E4E8">, </span><span style="--0:#F97583">P</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">LogProcessor</span><span style="--0:#E1E4E8">> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">CommandOperations</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 一致性协议初始化，根据 Config 实现类</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">config</span><span style="--0:#99A0A6"> {@link Config}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">init</span><span style="--0:#E1E4E8">(T </span><span style="--0:#FFAB70">config</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Add a log handler</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">processors</span><span style="--0:#99A0A6"> {@link LogProcessor}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addLogProcessors</span><span style="--0:#E1E4E8">(Collection&#x3C;</span><span style="--0:#F97583">P</span><span style="--0:#E1E4E8">> </span><span style="--0:#FFAB70">processors</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Copy of metadata information for this consensus protocol</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 该一致性协议的元数据信息</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> metaData {@link ProtocolMetaData}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ProtocolMetaData </span><span style="--0:#B392F0">protocolMetaData</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Obtain data according to the request</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> data {@link Response}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Response </span><span style="--0:#B392F0">getData</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Get data asynchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> data {@link CompletableFuture&#x3C;Response>}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    CompletableFuture&#x3C;</span><span style="--0:#F97583">Response</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">aGetData</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Data operation, returning submission results synchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">data</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> submit operation result {@link Response}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Response </span><span style="--0:#B392F0">submit</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">data</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Data submission operation, returning submission results asynchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">data</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link CompletableFuture&#x3C;Response>} submit result</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span><span style="--0:#99A0A6"> when submit throw Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    CompletableFuture&#x3C;</span><span style="--0:#F97583">Response</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">submitAsync</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">data</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * New member list</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">addresses</span><span style="--0:#99A0A6"> [ip:port, ip:port, ...]</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">memberChange</span><span style="--0:#E1E4E8">(Set&#x3C;</span><span style="--0:#F97583">String</span><span style="--0:#E1E4E8">> </span><span style="--0:#FFAB70">addresses</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Consistency agreement service shut down</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 一致性协议服务关闭</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">shutdown</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public interface ConsistencyProtocol<T extends Config, P extends LogProcessor> extends CommandOperations {    /**     * Consistency protocol initialization: perform initialization operations based on the incoming Config     * 一致性协议初始化，根据 Config 实现类     *     * @param config {@link Config}     */    void init(T config);    /**     * Add a log handler     *     * @param processors {@link LogProcessor}     */    void addLogProcessors(Collection<P> processors);    /**     * Copy of metadata information for this consensus protocol     * 该一致性协议的元数据信息     *     * @return metaData {@link ProtocolMetaData}     */    ProtocolMetaData protocolMetaData();    /**     * Obtain data according to the request     *     * @param request request     * @return data {@link Response}     * @throws Exception     */    Response getData(GetRequest request) throws Exception;    /**     * Get data asynchronously     *     * @param request request     * @return data {@link CompletableFuture<Response>}     */    CompletableFuture<Response> aGetData(GetRequest request);    /**     * Data operation, returning submission results synchronously     * 同步数据提交，在 Datum 中已携带相应的数据操作信息     *     * @param data {@link Log}     * @return submit operation result {@link Response}     * @throws Exception     */    Response submit(Log data) throws Exception;    /**     * Data submission operation, returning submission results asynchronously     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中     *     * @param data {@link Log}     * @return {@link CompletableFuture<Response>} submit result     * @throws Exception when submit throw Exception     */    CompletableFuture<Response> submitAsync(Log data);    /**     * New member list     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开     *     * @param addresses [ip:port, ip:port, ...]     */    void memberChange(Set<String> addresses);    /**     * Consistency agreement service shut down     * 一致性协议服务关闭     */    void shutdown();}"><div></div></button></div></figure></div>
<p>而针对CP协议，由于存在Leader的概念，因此需要提供一个方法用于获取CP协议当前的Leader是谁</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">interface</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">CPProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">C</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Config</span><span style="--0:#E1E4E8">> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ConsistencyProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">C</span><span style="--0:#E1E4E8">> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">  /**</span></div><div class="ec-line"><span style="--0:#99A0A6">   * Returns whether this node is a leader node</span></div><div class="ec-line"><span style="--0:#99A0A6">   *</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">group</span><span style="--0:#99A0A6"> business module info</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> is leader</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">   */</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">isLeader</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">group</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public interface CPProtocol<C extends Config> extends ConsistencyProtocol<C> {  /**   * Returns whether this node is a leader node   *   * @param group business module info   * @return is leader   * @throws Exception   */  boolean isLeader(String group) throws Exception;}"><div></div></button></div></figure></div>
<p><a name="oJFpB"></a></p>
<h4 id="数据操作请求提交对象loggetrequest">数据操作请求提交对象：Log、GetRequest</h4>
<p>上面说到，一致性协议其实是对于数据操作而言的，数据操作基本分为两大类：数据查询以及数据修改，同时还要满足不同功能模块之间的数据进行隔离。因此这里针对数据修改操作以及数据查询操作分别阐述。</p>
<ol>
<li>数据修改
<ol>
<li>数据修改操作，一定要知道本次请求是属于哪一个功能模块的</li>
<li>数据修改操作，首先一定要知道这个数据的修改操作具体是哪一种修改操作，方便功能模块针对真正的数据修改操作进行相应的逻辑操作</li>
<li>数据修改操作，一定要知道修改的数据是什么，即请求体，为了使得一致性协议层更为通用，这里对于请求体的数据结构，选择了byte[]数组</li>
<li>数据的类型，由于我们将真正的数据序列化为了byte[]数组，为了能够正常序列化，我们可能还需要记录这个数据的类型是什么</li>
<li>本次请求的信息摘要或者标识信息</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出Log对象的设计如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">message Log {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// 功能模块分组信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string group </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 摘要或者标识</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string key </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 具体请求数据</span></div><div class="ec-line"><span style="--0:#E1E4E8">    bytes data </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 数据类型</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string type </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">4</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 更为具体的数据操作</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string operation </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 额外信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">string, string</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> extendInfo </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">6</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="message Log {  // 功能模块分组信息    string group = 1;    // 摘要或者标识    string key = 2;    // 具体请求数据    bytes data = 3;    // 数据类型    string type = 4;    // 更为具体的数据操作    string operation = 5;    // 额外信息    map<string, string> extendInfo = 6;}"><div></div></button></div></figure></div>
<ol start="2">
<li>数据查询
<ol>
<li>数据查询操作，一定要知道本次请求是由哪一个功能模块发起的</li>
<li>数据查询的条件是什么，为了兼容各种存储结构的数据查询操作，这里用byte[]进行存储</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出GetRequest对象的设计如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">message GetRequest {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// 功能模块分组信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string group </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 具体请求数据</span></div><div class="ec-line"><span style="--0:#E1E4E8">    bytes data </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 额外信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">string, string</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> extendInfo </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="message GetRequest {  // 功能模块分组信息    string group = 1;    // 具体请求数据    bytes data = 2;    // 额外信息    map<string, string> extendInfo = 3;}"><div></div></button></div></figure></div>
<p><a name="vBig4"></a></p>
<h4 id="功能模块使用一致性协议logprocessor">功能模块使用一致性协议：LogProcessor</h4>
<p>当数据操作通过一致性协议进行submit之后，每个节点需要去处理这个Log或者GetRequest对象，因此，我们需要抽象出一个Log、GetRequest对象的Processor，不同的功能模块通过实现该处理器，ConsistencyProtocol内部会根据Log、GetRequest的group属性，将Log、GetRequest对象路由到具体的Processor，当然，Processor也需要表明自己是属于哪一个功能模块的。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * get data by key</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request {@link GetRequest}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> target type data</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> Response </span><span style="--0:#B392F0">onRequest</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Process Submitted Log</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">log</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link boolean}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> Response </span><span style="--0:#B392F0">onApply</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">log</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Irremediable errors that need to trigger business price cuts</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">error</span><span style="--0:#99A0A6"> {@link Throwable}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onError</span><span style="--0:#E1E4E8">(Throwable </span><span style="--0:#FFAB70">error</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * In order for the state machine that handles the transaction to be able to route</span></div><div class="ec-line"><span style="--0:#99A0A6">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span></div><div class="ec-line"><span style="--0:#99A0A6">     * information</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> Business unique identification name</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> String </span><span style="--0:#B392F0">group</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public abstract class LogProcessor {    /**     * get data by key     *     * @param request request {@link GetRequest}     * @return target type data     */    public abstract Response onRequest(GetRequest request);    /**     * Process Submitted Log     *     * @param log {@link Log}     * @return {@link boolean}     */    public abstract Response onApply(Log log);    /**     * Irremediable errors that need to trigger business price cuts     *     * @param error {@link Throwable}     */    public void onError(Throwable error) {    }    /**     * In order for the state machine that handles the transaction to be able to route     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity     * information     *     * @return Business unique identification name     */    public abstract String group();}"><div></div></button></div></figure></div>
<p>针对CP协议，比如Raft协议，存在快照的设计，因此我们需要针对CP协议单独扩展出一个方法</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor4CP</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Discovery snapshot handler</span></div><div class="ec-line"><span style="--0:#99A0A6">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link List &#x3C;SnapshotOperate>}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> List&#x3C;</span><span style="--0:#F97583">SnapshotOperation</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">loadSnapshotOperate</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> Collections.</span><span style="--0:#B392F0">emptyList</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public abstract class LogProcessor4CP extends LogProcessor {    /**     * Discovery snapshot handler     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself     *     * @return {@link List <SnapshotOperate>}     */    public List<SnapshotOperation> loadSnapshotOperate() {        return Collections.emptyList();    }}"><div></div></button></div></figure></div>
<p><a name="zbsAE"></a></p>
<h4 id="综述">综述</h4>
<p>从上面这几点可以看出来，ConsistencyProtocol是对上层功能模块暴露出来的使用接口，每个ConsistencyProtocol后面有具体的一致性协议实现的Backend，由于Backend无法很好的兼容nacos现有的架构设计，因此额外设计的LogProcessor就是为了解决这个问题。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015048030-8a4bff4a-20ed-46dd-a7f7-98655b22946f.png#align=left&#x26;display=inline&#x26;height=591&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=591&#x26;originWidth=886&#x26;size=93327&#x26;status=done&#x26;style=none&#x26;width=886" alt="image.png"><br>同时，由于在一致性协议层内部的Backend中需要实现对不同业务模块的数据进行隔离处理，而这个一块逻辑由请求对象和LogProcessor的group属性来实现<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015155835-a897262e-8e57-409c-bf94-d57bf765c80b.png#align=left&#x26;display=inline&#x26;height=591&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=591&#x26;originWidth=910&#x26;size=118083&#x26;status=done&#x26;style=none&#x26;width=910" alt="image.png"></p>
<p><a name="C1yU6"></a></p>
<h3 id="一致性协议层工作流程">一致性协议层工作流程</h3>
<p>我们可以通过一个时序图看看，一致性协议层的大致工作流程
<img src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt=""></p>
<p><a name="xtBNU"></a></p>
<h3 id="nacos一致性协议层之cp协议的实现选择jraft">Nacos一致性协议层之CP协议的实现选择——JRaft</h3>
<p>一致性协议层抽象好之后，剩下就是具体一致性协议实现的选择了，这里我们选择了蚂蚁金服开源的JRaft，那么我们如何将JRaft作为CP协议的一个Backend呢？下面的简单流程图描述了当JRaft作为CP协议的一个Backend时的初始化流程</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">/**</span></div><div class="ec-line"><span style="--0:#99A0A6"> * A concrete implementation of CP protocol: JRaft</span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * &#x3C;pre></span></div><div class="ec-line"><span style="--0:#99A0A6"> *                                           ┌──────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                                           │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            ┌──────────────────────┐       │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │        └───────────────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      ┌──────────────────────────────────┐ │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      └──────────────────────────────────┘ │             │  get p.group()  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │             └─────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 ┌─────────────┐           │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 │ RaftConfig  │           │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │      │  create raft group service   │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │      └──────────────────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              ┌──────────────────┐         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              │  JRaftProtocol   │         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              └──────────────────┘         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                     init()                │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               ┌─────────────────┐         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               │   JRaftServer   │         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               └─────────────────┘         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             ┌────────────────────┐        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             │JRaftServer.start() │        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             └────────────────────┘        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        └──────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> * &#x3C;/pre></span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * </span><span style="--0:#F97583">@author</span><span style="--0:#99A0A6"> &#x3C;a href="mailto:liaochuntao@live.com">liaochuntao&#x3C;/a></span></div><div class="ec-line"><span style="--0:#99A0A6"> */</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * A concrete implementation of CP protocol: JRaft * * <pre> *                                           ┌──────────────────────┐ *                                           │                      │ *            ┌──────────────────────┐       │                      ▼ *            │   ProtocolManager    │       │        ┌───────────────────────────┐ *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ *                        │                  │        └───────────────────────────┘ *                        ▼                  │                      │ *      ┌──────────────────────────────────┐ │                      ▼ *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐ *      └──────────────────────────────────┘ │             │  get p.group()  │ *                        │                  │             └─────────────────┘ *                        ▼                  │                      │ *                 ┌─────────────┐           │                      │ *                 │ RaftConfig  │           │                      ▼ *                 └─────────────┘           │      ┌──────────────────────────────┐ *                        │                  │      │  create raft group service   │ *                        ▼                  │      └──────────────────────────────┘ *              ┌──────────────────┐         │ *              │  JRaftProtocol   │         │ *              └──────────────────┘         │ *                        │                  │ *                     init()                │ *                        │                  │ *                        ▼                  │ *               ┌─────────────────┐         │ *               │   JRaftServer   │         │ *               └─────────────────┘         │ *                        │                  │ *                        │                  │ *                        ▼                  │ *             ┌────────────────────┐        │ *             │JRaftServer.start() │        │ *             └────────────────────┘        │ *                        │                  │ *                        └──────────────────┘ * </pre> * * @author <a href=&#x22;mailto:liaochuntao@live.com&#x22;>liaochuntao</a> */"><div></div></button></div></figure></div>
<p>JRaftProtocol是当JRaft作为CP协议的Backend时的一个ConsistencyProtocol的具体实现，其内部有一个JRaftServer成员属性，JRaftServer分装了JRaft的各种API操作，比如数据操作的提交，数据的查询，成员节点的变更，Leader节点的查询等等。</p>
<p><em><strong>注意事项：JRaft运行期间产生的数据在${nacos.home}/data/protocol/raft文件目录下。不同的业务模块有不同的文件分组，如果当节点出现crash或者异常关闭时，清空该目录下的文件，重启节点即可</strong></em></p>
<p>由于JRaft实现了raft group的概念，因此，完全可以利用raft group的设计，为每个功能模块单独创建一个raft group。这里给出部分代码，该代码体现了如何将LogProcessor嵌入到状态机中并为每个LogPrcessor创建一个Raft Group</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">synchronized</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">createMultiRaftGroup</span><span style="--0:#E1E4E8">(Collection</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">LogProcessor4CP</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> processors) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// There is no reason why the LogProcessor cannot be processed because of the synchronization</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">!</span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.isStarted) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.processors.</span><span style="--0:#B392F0">addAll</span><span style="--0:#E1E4E8">(processors);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String parentPath </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> Paths</span></div><div class="ec-line"><span style="--0:#E1E4E8">        .</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getNacosHome</span><span style="--0:#E1E4E8">(), </span><span style="--0:#9ECBFF">"data/protocol/raft"</span><span style="--0:#E1E4E8">).</span><span style="--0:#B392F0">toString</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">for</span><span style="--0:#E1E4E8"> (LogProcessor4CP processor </span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> processors) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String groupName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> processor.</span><span style="--0:#B392F0">group</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (multiRaftGroup.</span><span style="--0:#B392F0">containsKey</span><span style="--0:#E1E4E8">(groupName)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">DuplicateRaftGroupException</span><span style="--0:#E1E4E8">(groupName);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Ensure that each Raft Group has its own configuration and NodeOptions</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Configuration configuration </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> conf.</span><span style="--0:#B392F0">copy</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    NodeOptions copy </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> nodeOptions.</span><span style="--0:#B392F0">copy</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    JRaftUtils.</span><span style="--0:#B392F0">initDirectory</span><span style="--0:#E1E4E8">(parentPath, groupName, copy);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Here, the LogProcessor is passed into StateMachine, and when the StateMachine</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// triggers onApply, the onApply of the LogProcessor is actually called</span></div><div class="ec-line"><span style="--0:#E1E4E8">    NacosStateMachine machine </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosStateMachine</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">, processor);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setFsm</span><span style="--0:#E1E4E8">(machine);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setInitialConf</span><span style="--0:#E1E4E8">(configuration);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Set snapshot interval, default 1800 seconds</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> doSnapshotInterval </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> ConvertUtils.</span><span style="--0:#B392F0">toInt</span><span style="--0:#E1E4E8">(raftConfig</span></div><div class="ec-line"><span style="--0:#E1E4E8">              .</span><span style="--0:#B392F0">getVal</span><span style="--0:#E1E4E8">(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// If the business module does not implement a snapshot processor, cancel the snapshot</span></div><div class="ec-line"><span style="--0:#E1E4E8">    doSnapshotInterval </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> CollectionUtils</span></div><div class="ec-line"><span style="--0:#E1E4E8">          .</span><span style="--0:#B392F0">isEmpty</span><span style="--0:#E1E4E8">(processor.</span><span style="--0:#B392F0">loadSnapshotOperate</span><span style="--0:#E1E4E8">()) </span><span style="--0:#F97583">?</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">0</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> doSnapshotInterval;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setSnapshotIntervalSecs</span><span style="--0:#E1E4E8">(doSnapshotInterval);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.RAFT.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"create raft group : {}"</span><span style="--0:#E1E4E8">, groupName);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftGroupService raftGroupService </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">RaftGroupService</span><span style="--0:#E1E4E8">(groupName,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          localPeerId, copy, rpcServer, </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Because RpcServer has been started before, it is not allowed to start again here</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Node node </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> raftGroupService.</span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    machine.</span><span style="--0:#B392F0">setNode</span><span style="--0:#E1E4E8">(node);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RouteTable.</span><span style="--0:#B392F0">getInstance</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">updateConfiguration</span><span style="--0:#E1E4E8">(groupName, configuration);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftExecutor.</span><span style="--0:#B392F0">executeByCommon</span><span style="--0:#E1E4E8">(() </span><span style="--0:#F97583">-></span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">registerSelfToCluster</span><span style="--0:#E1E4E8">(groupName, localPeerId, configuration));</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Turn on the leader auto refresh for this group</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Random random </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Random</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> period </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> nodeOptions.</span><span style="--0:#B392F0">getElectionTimeoutMs</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> random.</span><span style="--0:#B392F0">nextInt</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">*</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1000</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftExecutor.</span><span style="--0:#B392F0">scheduleRaftMemberRefreshJob</span><span style="--0:#E1E4E8">(() </span><span style="--0:#F97583">-></span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">refreshRouteTable</span><span style="--0:#E1E4E8">(groupName),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          nodeOptions.</span><span style="--0:#B392F0">getElectionTimeoutMs</span><span style="--0:#E1E4E8">(), period, TimeUnit.MILLISECONDS);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    multiRaftGroup.</span><span style="--0:#B392F0">put</span><span style="--0:#E1E4E8">(groupName,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">RaftGroupTuple</span><span style="--0:#E1E4E8">(node, processor, raftGroupService, machine));</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="synchronized void createMultiRaftGroup(Collection<LogProcessor4CP> processors) {  // There is no reason why the LogProcessor cannot be processed because of the synchronization  if (!this.isStarted) {    this.processors.addAll(processors);    return;  }  final String parentPath = Paths        .get(ApplicationUtils.getNacosHome(), &#x22;data/protocol/raft&#x22;).toString();  for (LogProcessor4CP processor : processors) {    final String groupName = processor.group();    if (multiRaftGroup.containsKey(groupName)) {      throw new DuplicateRaftGroupException(groupName);    }    // Ensure that each Raft Group has its own configuration and NodeOptions    Configuration configuration = conf.copy();    NodeOptions copy = nodeOptions.copy();    JRaftUtils.initDirectory(parentPath, groupName, copy);    // Here, the LogProcessor is passed into StateMachine, and when the StateMachine    // triggers onApply, the onApply of the LogProcessor is actually called    NacosStateMachine machine = new NacosStateMachine(this, processor);    copy.setFsm(machine);    copy.setInitialConf(configuration);    // Set snapshot interval, default 1800 seconds    int doSnapshotInterval = ConvertUtils.toInt(raftConfig              .getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),          RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);    // If the business module does not implement a snapshot processor, cancel the snapshot    doSnapshotInterval = CollectionUtils          .isEmpty(processor.loadSnapshotOperate()) ? 0 : doSnapshotInterval;    copy.setSnapshotIntervalSecs(doSnapshotInterval);    Loggers.RAFT.info(&#x22;create raft group : {}&#x22;, groupName);    RaftGroupService raftGroupService = new RaftGroupService(groupName,          localPeerId, copy, rpcServer, true);    // Because RpcServer has been started before, it is not allowed to start again here    Node node = raftGroupService.start(false);    machine.setNode(node);    RouteTable.getInstance().updateConfiguration(groupName, configuration);    RaftExecutor.executeByCommon(() -> registerSelfToCluster(groupName, localPeerId, configuration));    // Turn on the leader auto refresh for this group    Random random = new Random();    long period = nodeOptions.getElectionTimeoutMs() + random.nextInt(5 * 1000);    RaftExecutor.scheduleRaftMemberRefreshJob(() -> refreshRouteTable(groupName),          nodeOptions.getElectionTimeoutMs(), period, TimeUnit.MILLISECONDS);    multiRaftGroup.put(groupName,          new RaftGroupTuple(node, processor, raftGroupService, machine));  }}"><div></div></button></div></figure></div>
<p><a name="4czvB"></a></p>
<h4 id="疑问解答为什么要创建多个raft-group">疑问解答：为什么要创建多个raft group</h4>
<p>或许有的人会有疑问，既然之前已经设计出了LogProcessor，完全可以利用一个Raft Group，在状态机appl时，根据Log的group属性进行路由到不同的LogProcessor即可，每个功能模块就创建一个raft group，不是会消耗大量的资源吗？<br>正如之前所说，我们希望独立工作的模块之间相互不存在影响，比如A模块处理Log因为存在Block操作可能使得apply的速度缓慢，亦或者可能中途发生异常，对于Raft协议来说，当日志apply失败时，状态机将不能够继续向前推进，因为如果继续向前推进的话，由于上一步的apply失败，后面的所有apply都可能失败，将会导致这个节点的数据与其他节点的数据永远不一致。如果说我们将所有独立工作的模块，对于数据操作的请求处理放在同一个raft group，即一个状态机中，就不可避免的会出现上述所说的问题，某个模块在apply日志发生不可控的因素时，会影响其他模块的正常工作。</p>
<p><a name="2GyRw"></a></p>
<h3 id="jraft运维操作">JRaft运维操作</h3>
<p>为了使用者能够对JRaft进行相关简单的运维，比如Leader的切换，重置当前Raft集群成员，触发某个节点进行Snapshot操作等等，提供了一个简单的HTTP接口进行操作，并且该接口有一定的限制，即每次只会执行一条运维指令</p>
<p>1、切换某一个Raft Group的Leader节点</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"transferLeader"</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;transferLeader&#x22;    &#x22;value&#x22;: &#x22;ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="Fs7VE"></a></p>
<p>2、重置某一个Raft Group的集群成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"resetRaftCluster"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;resetRaftCluster&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p>注意，该操作是一个高危操作，仅仅当Raft集群的 n/2 + 1节点crash之后无法满足过半投票的要求才可以使用该运维命令，用于快速让当前剩余的节点重组Raft集群，对外提供服务，但是这个操作很大程度会造成数据的丢失<br></p>
<p><a name="VfG5T"></a></p>
<p>3、触发某一个Raft Group执行快照操作</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"doSnapshot"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;doSnapshot&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="m9LfI"></a></p>
<p>4、移除某一个Raft Group中的某一成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"removePeer"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;removePeer&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="ev3MW"></a></p>
<p>5、批量移除某一个Raft Group中的多个成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"removePeers"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port},ip:{raft_port},ip:{raft_port},..."</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;removePeers&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port},ip:{raft_port},ip:{raft_port},...&#x22;}"><div></div></button></div></figure></div>
<p><a name="GzMuP"></a></p>
<h3 id="jraft协议相关配置参数">JRaft协议相关配置参数</h3>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">### Sets the Raft cluster election timeout, default value is 5 second</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.election_timeout_ms=5000</span></div><div class="ec-line"><span style="--0:#99A0A6">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span></div><div class="ec-line"><span style="--0:#99A0A6">### Requested retries, default value is 1</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.request_failoverRetries=1</span></div><div class="ec-line"><span style="--0:#99A0A6">### raft internal worker threads</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.core_thread_num=8</span></div><div class="ec-line"><span style="--0:#99A0A6">### Number of threads required for raft business request processing</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.cli_service_thread_num=4</span></div><div class="ec-line"><span style="--0:#99A0A6">### raft linear read strategy, defaults to index</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span></div><div class="ec-line"><span style="--0:#99A0A6">### rpc request timeout, default 5 seconds</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="### Sets the Raft cluster election timeout, default value is 5 secondnacos.core.protocol.raft.data.election_timeout_ms=5000### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minutenacos.core.protocol.raft.data.snapshot_interval_secs=30### Requested retries, default value is 1nacos.core.protocol.raft.data.request_failoverRetries=1### raft internal worker threadsnacos.core.protocol.raft.data.core_thread_num=8### Number of threads required for raft business request processingnacos.core.protocol.raft.data.cli_service_thread_num=4### raft linear read strategy, defaults to indexnacos.core.protocol.raft.data.read_index_type=ReadOnlySafe### rpc request timeout, default 5 secondsnacos.core.protocol.raft.data.rpc_request_timeout_ms=5000"><div></div></button></div></figure></div>
<h4 id="线性读参数解析">线性读参数解析</h4>
<ol>
<li><strong>ReadOnlySafe</strong>
<ol>
<li>该线性读模式，每次Follower进行读请求时，需要和Leader同步日志提交位点信息，而Leader，需要向过半的Follower发起证明自己是Leader的轻量的RPC请求，相当于一个Follower读，至少需要1 + （n/2）+ 1 次的RPC请求。</li>
</ol>
</li>
<li><strong>ReadOnlyLeaseBased</strong>
<ol>
<li>该线性读模式，每次Follower进行读请求时，Leader只需要判断自己的Leader租约是否过期了，如果没有过期，直接可以回复Follower自己是Leader，但是该机制对于机器时钟要求很严格，如果有做时钟同步的话，可以考虑使用该线性读模式。</li>
</ol>
</li>
</ol>
<p><a name="WiLDa"></a></p>
<h2 id="nacos内嵌分布式id">Nacos内嵌分布式ID</h2>
<p>nacos内嵌的分布式ID为Snakeflower，dataCenterId默认为1，workerId的值计算方式如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#9ECBFF">InetAddress address;</span></div><div class="ec-line"><span style="--0:#9ECBFF">try {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#9ECBFF">address = InetAddress.getLocalHost();</span></div><div class="ec-line"><span style="--0:#E1E4E8">} </span><span style="--0:#9ECBFF">catch (final UnknownHostException e) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#9ECBFF">throw new IllegalStateException(</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#9ECBFF">"Cannot get LocalHost InetAddress, please check your network!");</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line"><span style="--0:#9ECBFF">byte[] ipAddressByteArray = address.getAddress();</span></div><div class="ec-line"><span style="--0:#9ECBFF">workerId = (((ipAddressByteArray[ipAddressByteArray.length - 2] &#x26; 0B11)</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#9ECBFF">&#x3C;&#x3C; Byte.SIZE) + (ipAddressByteArray[ipAddressByteArray.length - 1]</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#FDAEB7;--0fs:italic">&#x26;</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">0xFF));</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="InetAddress address;try {  address = InetAddress.getLocalHost();} catch (final UnknownHostException e) {  throw new IllegalStateException(            &#x22;Cannot get LocalHost InetAddress, please check your network!&#x22;);}byte[] ipAddressByteArray = address.getAddress();workerId = (((ipAddressByteArray[ipAddressByteArray.length - 2] &#x26; 0B11)          << Byte.SIZE) + (ipAddressByteArray[ipAddressByteArray.length - 1]          &#x26; 0xFF));"><div></div></button></div></figure></div>
<p>如果需要手动指定dataCenterId以及workerId，则在application.properties或者启动时添加命令行参数</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">### set the dataCenterID manually</span></div><div class="ec-line"><span style="--0:#99A0A6"># nacos.core.snowflake.data-center=</span></div><div class="ec-line"><span style="--0:#99A0A6">### set the WorkerID manually</span></div><div class="ec-line"><span style="--0:#99A0A6"># nacos.core.snowflake.worker-id=</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="### set the dataCenterID manually# nacos.core.snowflake.data-center=### set the WorkerID manually# nacos.core.snowflake.worker-id="><div></div></button></div></figure></div>
<p><a name="ZLp5w"></a></p>
<h2 id="nacos内嵌的轻量的基于derby的分布式关系型存储">Nacos内嵌的轻量的基于Derby的分布式关系型存储</h2>
<p><a name="1B5KV"></a></p>
<h3 id="背景">背景</h3>
<ol>
<li>如果配置文件数量较少，在集群模式下需要高可用数据库集群作为支撑的成本太大，期望有一个轻量的分布式关系型存储来解决</li>
<li>nacos内部一些元数据信息存储，比如用户信息，命名空间信息</li>
<li>思路来源：<a href="https://github.com/rqlite/rqlite" rel="noopener noreferrer" target="_blank">https://github.com/rqlite/rqlite</a></li>
</ol>
<p><a name="Du2qc"></a></p>
<h3 id="设计思路">设计思路</h3>
<p><a name="NzxHa"></a></p>
<h4 id="目标">目标</h4>
<p>设计目标，是期望nacos存在两种数据存储模式，一种是现在的方式，数据存储在外置数据源（关系型数据库）；第二种方式是内嵌存储数据源（Apache Derby）。用户能够使用命令行参数配置的方式，随意使用这两种数据存储模式<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015542106-f14d2579-229f-4bfb-a432-e40854e65d6d.png#align=left&#x26;display=inline&#x26;height=903&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=903&#x26;originWidth=1514&#x26;size=237497&#x26;status=done&#x26;style=none&#x26;width=1514" alt="image.png"></p>
<p><a name="LqUtU"></a></p>
<h4 id="总体">总体</h4>
<p>将一次请求操作涉及的SQL上下文按顺序保存起来。然后通过一致协议层将本次请求涉及的SQL上下文进行同步，然后每个节点将其解析并重新按顺序在一次数据库会话中执行。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&#x26;display=inline&#x26;height=814&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&#x26;originHeight=814&#x26;originWidth=1149&#x26;size=130886&#x26;status=done&#x26;style=none&#x26;width=1149" alt="未命名文件 (1).png"></p>
<p><a name="yxFYn"></a></p>
<h4 id="谁可以处理请求">谁可以处理请求</h4>
<p>当使用者开启1.3.0的新特性——内嵌分布式关系型数据存储时，所有的写操作请求都将路由到Leader节点进行处理；但是，由于Raft状态机的特性，当某一个节点在apply数据库操作请求时发生非SQL逻辑错误引发的异常时，将导致状态机无法继续正常进行工作，此时将会触发配置管理模块的降级操作</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">registerSubscribe</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  NotifyCenter.</span><span style="--0:#B392F0">registerSubscribe</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SmartSubscribe</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onEvent</span><span style="--0:#E1E4E8">(Event </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorRecoverEvent) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        downgrading </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      }</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorEvent) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        downgrading </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">canNotify</span><span style="--0:#E1E4E8">(Event </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorEvent) </span><span style="--0:#F97583">||</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorRecoverEvent);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  });</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void registerSubscribe() {  NotifyCenter.registerSubscribe(new SmartSubscribe() {    @Override    public void onEvent(Event event) {      if (event instanceof RaftDBErrorRecoverEvent) {        downgrading = false;        return;      }      if (event instanceof RaftDBErrorEvent) {        downgrading = true;      }    }    @Override    public boolean canNotify(Event event) {      return (event instanceof RaftDBErrorEvent) || (event instanceof RaftDBErrorRecoverEvent);    }  });}"><div></div></button></div></figure></div>
<p>因此，综上所述，可以通过活动图来理解下，什么情况下需要将请求进行转发
<img src="https://cdn.nlark.com/yuque/__puml/db53c1ade61235d4c9659607b98ef7c6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJGaWx0ZXIuZG9GaWx0ZXJcIlxuXG5pZiBcIuacrOiKgueCueaYr0xlYWRlclwiIHRoZW5cbiAgLWxlZnQtPlt0cnVlXSBcIuacrOiKgueCueWkhOeQhlwiXG4gIC0tPiAoKilcbmVsc2VcbiAgICBpZiBcIuezu-e7n-mZjee6p-W8gOWQr1wiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwi6L2s5Y-R57uZTGVhZGVyXCJcbiAgICAgICAgLS0-ICgqKVxuICAgIGVsc2VcbiAgICAgICAgaWYgXCLlhpnmk43kvZzor7fmsYJcIiB0aGVuXG4gICAgICAgICAgICAtLT5bdHJ1ZV0gXCLovazlj5Hnu5lMZWFkZXJcIlxuICAgICAgICAgICAgLS0-ICgqKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAtLT5bZmFsc2VdIFwi5pys6IqC54K55aSE55CGXCJcbiAgICAgICAgZW5kaWZcbiAgICBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IjFuWW9HIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9kYjUzYzFhZGU2MTIzNWQ0Yzk2NTk2MDdiOThlZjdjNi5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""></p>
<p><a name="g1buf"></a></p>
<h4 id="相关数据承载对象">相关数据承载对象</h4>
<p>数据库的DML语句是select、insert、update、delete，根据SQL语句对于数据操作的性质，可以分为两大类：query以及update，select语句对应的是数据查询，insert、update、delete语句对应的是数据修改。同时在进行数据库操作时，为了避免SQL注入，使用的是PreparedStatement，因此需要SQL语句+参数，因此可以得到两个关于数据库操作的Request对象</p>
<ol>
<li>SelectRequest</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SelectRequest</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">implements</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Serializable</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> serialVersionUID </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2212052574976898602L</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">byte</span><span style="--0:#E1E4E8"> queryType;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// sql语句</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// select * from config_info where</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String sql;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String className;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public class SelectRequest implements Serializable {    private static final long serialVersionUID = 2212052574976898602L;    // 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象    private byte queryType;    // sql语句    // select * from config_info where    private String sql;    private Object[] args;    private String className;}"><div></div></button></div></figure></div>
<ol start="2">
<li>ModifyRequest</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ModifyRequest</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">implements</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Serializable</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> serialVersionUID </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">4548851816596520564L</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> executeNo;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String sql;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public class ModifyRequest implements Serializable {    private static final long serialVersionUID = 4548851816596520564L;    private int executeNo;    private String sql;    private Object[] args;}"><div></div></button></div></figure></div>
<p><a name="moKl7"></a></p>
<h4 id="配置发布">配置发布</h4>
<p>配置发布操作涉及三个事务：</p>
<ol>
<li>config_info保存配置信息</li>
<li>config_tags_relation保存配置与标签的关联关系</li>
<li>his_config_info保存一条配置操作历史记录</li>
</ol>
<p>这三个事务都在配置发布这个大事务下，如果说我们对每个事务操作进行一个Raft协议提交，假设1、2两个事务通过Raft提交后都成功Apply了，第三个事务在进行Raft提交后apply失败，那么对于这个配置发布的大事务来说，是需要整体回滚的，否则就会违反原子性，那么可能需要说将事务回滚操作又进行一次Raft提交，那么整体的复杂程度上升，并且直接引入了分布式事务的管理，因此为了避免这个问题，我们将这三个事务涉及的SQL上下文进行整合成一个大的SQL上下文，对这大的SQL上下文进行Raft协议提交。保证了三个子事务在同一次数据库会话当中，成功解决原子性的问题，同时由于Raft协议对于事务日志的处理是串行执行的，因此相当于将数据库的事务隔离级别调整为串行化。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigInfo</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcIp,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ConfigInfo configInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> configAdvanceInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> notify) {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String tenantTmp </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">()) </span><span style="--0:#F97583">?</span></div><div class="ec-line"><span style="--0:#E1E4E8">          StringUtils.EMPTY </span><span style="--0:#F97583">:</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    configInfo.</span><span style="--0:#B392F0">setTenant</span><span style="--0:#E1E4E8">(tenantTmp);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#99A0A6">// 通过雪花ID算法获取数据库主键</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configId </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> idGeneratorManager.</span><span style="--0:#B392F0">nextId</span><span style="--0:#E1E4E8">(RESOURCE_CONFIG_INFO_ID);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> hisId </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> idGeneratorManager.</span><span style="--0:#B392F0">nextId</span><span style="--0:#E1E4E8">(RESOURCE_CONFIG_HISTORY_ID);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">addConfigInfoAtomic</span><span style="--0:#E1E4E8">(configId, srcIp, srcUser, configInfo, time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configAdvanceInfo);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    String configTags </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> configAdvanceInfo </span><span style="--0:#F97583">==</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">?</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">:</span></div><div class="ec-line"><span style="--0:#E1E4E8">          (String) configAdvanceInfo.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"config_tags"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">addConfigTagsRelation</span><span style="--0:#E1E4E8">(configId, configTags, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">());</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">insertConfigHistoryAtomic</span><span style="--0:#E1E4E8">(hisId, configInfo, srcIp, srcUser, time, </span><span style="--0:#9ECBFF">"I"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    EmbeddedStorageContextUtils.</span><span style="--0:#B392F0">onModifyConfigInfo</span><span style="--0:#E1E4E8">(configInfo, srcIp, time);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    databaseOperate.</span><span style="--0:#B392F0">blockUpdate</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">finally</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    EmbeddedStorageContextUtils.</span><span style="--0:#B392F0">cleanAllContext</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigInfoAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> id, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcIp,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ConfigInfo configInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> configAdvanceInfo) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 参数处理</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,"</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { id, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), tenantTmp, appNameTmp, configInfo.</span><span style="--0:#B392F0">getContent</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };</span></div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> id;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigTagRelationAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configId, String tagName, String dataId,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      String group, String tenant) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) "</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"VALUES(?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { configId, tagName, </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8">, dataId, group,</span></div><div class="ec-line"><span style="--0:#E1E4E8">        tenant };</span></div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">insertConfigHistoryAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configHistoryId, ConfigInfo configInfo,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      String srcIp, String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time, String ops) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 参数处理</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,"</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { configHistoryId, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), tenantTmp, appNameTmp, configInfo.</span><span style="--0:#B392F0">getContent</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        md5Tmp, srcIp, srcUser, time, ops };</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">/**</span></div><div class="ec-line"><span style="--0:#99A0A6"> * Temporarily saves all insert, update, and delete statements under</span></div><div class="ec-line"><span style="--0:#99A0A6"> * a transaction in the order in which they occur</span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * </span><span style="--0:#F97583">@author</span><span style="--0:#99A0A6"> &#x3C;a href="mailto:liaochuntao@live.com">liaochuntao&#x3C;/a></span></div><div class="ec-line"><span style="--0:#99A0A6"> */</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SqlContextUtils</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ThreadLocal&#x3C;ArrayList&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">>> SQL_CONTEXT </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">            ThreadLocal.</span><span style="--0:#B392F0">withInitial</span><span style="--0:#E1E4E8">(ArrayList</span><span style="--0:#F97583">::new</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">sql</span><span style="--0:#E1E4E8">, Object... </span><span style="--0:#FFAB70">args</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ArrayList&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">> requests </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> SQL_CONTEXT.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ModifyRequest context </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ModifyRequest</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setExecuteNo</span><span style="--0:#E1E4E8">(requests.</span><span style="--0:#B392F0">size</span><span style="--0:#E1E4E8">());</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setSql</span><span style="--0:#E1E4E8">(sql);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setArgs</span><span style="--0:#E1E4E8">(args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        requests.</span><span style="--0:#B392F0">add</span><span style="--0:#E1E4E8">(context);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        SQL_CONTEXT.</span><span style="--0:#B392F0">set</span><span style="--0:#E1E4E8">(requests);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> List&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">getCurrentSqlContext</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> SQL_CONTEXT.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">cleanCurrentSqlContext</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        SQL_CONTEXT.</span><span style="--0:#B392F0">remove</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void addConfigInfo(final String srcIp,      final String srcUser, final ConfigInfo configInfo, final Timestamp time,      final Map<String, Object> configAdvanceInfo, final boolean notify) {  try {    final String tenantTmp = StringUtils.isBlank(configInfo.getTenant()) ?          StringUtils.EMPTY :          configInfo.getTenant();    configInfo.setTenant(tenantTmp);        // 通过雪花ID算法获取数据库主键    long configId = idGeneratorManager.nextId(RESOURCE_CONFIG_INFO_ID);    long hisId = idGeneratorManager.nextId(RESOURCE_CONFIG_HISTORY_ID);    addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time,          configAdvanceInfo);    String configTags = configAdvanceInfo == null ?          null :          (String) configAdvanceInfo.get(&#x22;config_tags&#x22;);    addConfigTagsRelation(configId, configTags, configInfo.getDataId(),          configInfo.getGroup(), configInfo.getTenant());    insertConfigHistoryAtomic(hisId, configInfo, srcIp, srcUser, time, &#x22;I&#x22;);    EmbeddedStorageContextUtils.onModifyConfigInfo(configInfo, srcIp, time);    databaseOperate.blockUpdate();  }  finally {    EmbeddedStorageContextUtils.cleanAllContext();  }}public long addConfigInfoAtomic(final long id, final String srcIp,      final String srcUser, final ConfigInfo configInfo, final Timestamp time,      Map<String, Object> configAdvanceInfo) {  ...    // 参数处理    ...  final String sql =        &#x22;INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,&#x22;            + &#x22;gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { id, configInfo.getDataId(),        configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),        md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };  SqlContextUtils.addSqlContext(sql, args);  return id;}public void addConfigTagRelationAtomic(long configId, String tagName, String dataId,      String group, String tenant) {  final String sql =        &#x22;INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) &#x22;            + &#x22;VALUES(?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { configId, tagName, null, dataId, group,        tenant };  SqlContextUtils.addSqlContext(sql, args);}public void insertConfigHistoryAtomic(long configHistoryId, ConfigInfo configInfo,      String srcIp, String srcUser, final Timestamp time, String ops) {  ...    // 参数处理    ...  final String sql =        &#x22;INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,&#x22;            + &#x22;src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { configHistoryId, configInfo.getDataId(),        configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),        md5Tmp, srcIp, srcUser, time, ops };  SqlContextUtils.addSqlContext(sql, args);}/** * Temporarily saves all insert, update, and delete statements under * a transaction in the order in which they occur * * @author <a href=&#x22;mailto:liaochuntao@live.com&#x22;>liaochuntao</a> */public class SqlContextUtils {    private static final ThreadLocal<ArrayList<ModifyRequest>> SQL_CONTEXT =            ThreadLocal.withInitial(ArrayList::new);    public static void addSqlContext(String sql, Object... args) {        ArrayList<ModifyRequest> requests = SQL_CONTEXT.get();        ModifyRequest context = new ModifyRequest();        context.setExecuteNo(requests.size());        context.setSql(sql);        context.setArgs(args);        requests.add(context);        SQL_CONTEXT.set(requests);    }    public static List<ModifyRequest> getCurrentSqlContext() {        return SQL_CONTEXT.get();    }    public static void cleanCurrentSqlContext() {        SQL_CONTEXT.remove();    }}"><div></div></button></div></figure></div>
<p>通过一个时序图来更加直观的理解
<img src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt=""></p>
<p><a name="AAJTE"></a></p>
<h3 id="如何使用新特性">如何使用新特性</h3>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">./startup.sh</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-p</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">embedded</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="./startup.sh -p embedded"><div></div></button></div></figure></div>
<p>是否启用内嵌的分布式关系型存储的活动图
<img src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""></p>
<p><a name="9UAXN"></a></p>
<h3 id="新特性的相关运维操作">新特性的相关运维操作</h3>
<p>直接查询每个节点的derby存储的数据</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">GET </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">cs</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">derby</span><span style="--0:#F97583">?</span><span style="--0:#E1E4E8">sql</span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8">select </span><span style="--0:#F97583">*</span><span style="--0:#E1E4E8"> from config_info</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> List</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">>></span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="GET /nacos/v1/cs/ops/derby?sql=select * from config_inforeturn List<Map<String, Object>>"><div></div></button></div></figure></div>
<p><a name="YcqO2"></a></p>
<h3 id="不足">不足</h3>
<ol>
<li>在数据库上层构建一层分布式数据操作同步层，对数据库的操作存在了限制，比如第一步insert操作，然后select操作，最后在update操作，这种在数据修改语句中穿插着查询语句的操作顺序是不支持的</li>
<li>限制了数据库的性能，由于间接的将数据库事务隔离级别调整为了串行化，人为的将并发能力降低了</li>
</ol>
<p><a name="7dul8"></a></p>
<h3 id="未来演进">未来演进</h3>
<p>将于Apache Derby官方一起尝试基于Raft实现BingLog的同步复制操作，从底层实现数据库同步能力</p>  </div> </div>  </div> <div class="inline-block w-[30%] fixed bg-gray-14 h-full"> <aside> <div class="nav myroot prose"><ul>
<li>
<p><a href="#nacos-130-%E7%89%B9%E6%80%A7%E4%BB%A5%E5%8F%8A%E5%8A%9F%E8%83%BD%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3">Nacos 1.3.0 特性以及功能使用文档</a></p>
<ul>
<li>
<p><a href="#%E6%A6%82%E8%BF%B0">概述</a></p>
</li>
<li>
<p><a href="#%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E5%8F%98%E5%8C%96">系统参数变化</a></p>
<ul>
<li><a href="#%E6%96%B0%E5%A2%9E">新增</a></li>
</ul>
</li>
<li>
<p><a href="#nacos%E7%9A%84%E6%9C%AA%E6%9D%A5%E6%95%B4%E4%BD%93%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E7%BB%84%E4%BB%B6">Nacos的未来整体逻辑架构及其组件</a></p>
</li>
<li>
<p><a href="#nacos%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E8%8A%82%E7%82%B9%E5%AF%BB%E5%9D%80%E6%A8%A1%E5%BC%8F">Nacos集群成员节点寻址模式</a></p>
<ul>
<li>
<p><a href="#%E5%AF%BB%E5%9D%80%E6%A8%A1%E5%BC%8F%E8%AF%A6%E7%BB%86">寻址模式详细</a></p>
<ul>
<li><a href="#fileconfigmemberlookup">FileConfigMemberLookup</a></li>
<li><a href="#addressservermemberlookup">AddressServerMemberLookup</a></li>
</ul>
</li>
<li>
<p><a href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86%E5%92%8C%E5%AF%BB%E5%9D%80%E6%A8%A1%E5%BC%8F%E5%A6%82%E4%BD%95%E7%BB%93%E5%90%88%E7%9A%84">节点管理和寻址模式如何结合的</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#nacos%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%E5%8D%8F%E8%AE%AE%E5%B1%82%E6%8A%BD%E8%B1%A1">Nacos一致性协议协议层抽象</a></p>
<ul>
<li>
<p><a href="#%E4%B8%80%E8%87%B4%E5%8D%8F%E8%AE%AE%E6%8A%BD%E8%B1%A1">一致协议抽象</a></p>
<ul>
<li><a href="#consistencyprotocol">ConsistencyProtocol</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E8%AF%B7%E6%B1%82%E6%8F%90%E4%BA%A4%E5%AF%B9%E8%B1%A1loggetrequest">数据操作请求提交对象：Log、GetRequest</a></li>
<li><a href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AElogprocessor">功能模块使用一致性协议：LogProcessor</a></li>
<li><a href="#%E7%BB%BC%E8%BF%B0">综述</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%E5%B1%82%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">一致性协议层工作流程</a></p>
</li>
<li>
<p><a href="#nacos%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%E5%B1%82%E4%B9%8Bcp%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%AE%9E%E7%8E%B0%E9%80%89%E6%8B%A9jraft">Nacos一致性协议层之CP协议的实现选择——JRaft</a></p>
<ul>
<li><a href="#%E7%96%91%E9%97%AE%E8%A7%A3%E7%AD%94%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%9B%E5%BB%BA%E5%A4%9A%E4%B8%AAraft-group">疑问解答：为什么要创建多个raft group</a></li>
</ul>
</li>
<li>
<p><a href="#jraft%E8%BF%90%E7%BB%B4%E6%93%8D%E4%BD%9C">JRaft运维操作</a></p>
</li>
<li>
<p><a href="#jraft%E5%8D%8F%E8%AE%AE%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0">JRaft协议相关配置参数</a></p>
<ul>
<li><a href="#%E7%BA%BF%E6%80%A7%E8%AF%BB%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90">线性读参数解析</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#nacos%E5%86%85%E5%B5%8C%E5%88%86%E5%B8%83%E5%BC%8Fid">Nacos内嵌分布式ID</a></p>
</li>
<li>
<p><a href="#nacos%E5%86%85%E5%B5%8C%E7%9A%84%E8%BD%BB%E9%87%8F%E7%9A%84%E5%9F%BA%E4%BA%8Ederby%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%B3%E7%B3%BB%E5%9E%8B%E5%AD%98%E5%82%A8">Nacos内嵌的轻量的基于Derby的分布式关系型存储</a></p>
<ul>
<li>
<p><a href="#%E8%83%8C%E6%99%AF">背景</a></p>
</li>
<li>
<p><a href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF">设计思路</a></p>
<ul>
<li><a href="#%E7%9B%AE%E6%A0%87">目标</a></li>
<li><a href="#%E6%80%BB%E4%BD%93">总体</a></li>
<li><a href="#%E8%B0%81%E5%8F%AF%E4%BB%A5%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82">谁可以处理请求</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E6%89%BF%E8%BD%BD%E5%AF%B9%E8%B1%A1">相关数据承载对象</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E5%8F%91%E5%B8%83">配置发布</a></li>
</ul>
</li>
<li>
<p><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%96%B0%E7%89%B9%E6%80%A7">如何使用新特性</a></p>
</li>
<li>
<p><a href="#%E6%96%B0%E7%89%B9%E6%80%A7%E7%9A%84%E7%9B%B8%E5%85%B3%E8%BF%90%E7%BB%B4%E6%93%8D%E4%BD%9C">新特性的相关运维操作</a></p>
</li>
<li>
<p><a href="#%E4%B8%8D%E8%B6%B3">不足</a></p>
</li>
<li>
<p><a href="#%E6%9C%AA%E6%9D%A5%E6%BC%94%E8%BF%9B">未来演进</a></p>
</li>
</ul>
</li>
</ul>
</li>
</ul></div> </aside> </div> </div>   </body> </html>