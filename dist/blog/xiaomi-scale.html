<!DOCTYPE html><html lang="en" data-theme="light" class="astro-37fxchfa"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="referrer" content="no-referrer"><meta name="generator" content="Astro v4.0.6"><title>Nacos Blog</title><style>.sl-markdown-content :not(h1,h2,h3,h4,h5,h6)+:is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){margin-top:2.5rem;scroll-margin-top:4rem}.sl-markdown-content li+li:not(:where(.not-content *)),.sl-markdown-content dt+dt:not(:where(.not-content *)),.sl-markdown-content dt+dd:not(:where(.not-content *)),.sl-markdown-content dd+dd:not(:where(.not-content *)){margin-top:.25rem}.sl-markdown-content li>:last-child:not(li,ul,ol):not(a,strong,em,del,span,input,:where(.not-content *)){margin-bottom:1.25rem}.sl-markdown-content dt:not(:where(.not-content *)){font-weight:700}.sl-markdown-content dd:not(:where(.not-content *)){padding-inline-start:1rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){color:#f4f4f6;line-height:var(--sl-line-height-headings);font-weight:600}.sl-markdown-content :is(img,picture,video,canvas,svg,iframe):not(:where(.not-content *)){display:block;max-width:100%;height:auto}.sl-markdown-content h1:not(:where(.not-content *)){font-size:var(--sl-text-h1)}.sl-markdown-content h2:not(:where(.not-content *)){font-size:var(--sl-text-h2)}.sl-markdown-content h3:not(:where(.not-content *)){font-size:var(--sl-text-h3)}.sl-markdown-content h4:not(:where(.not-content *)){font-size:var(--sl-text-h4)}.sl-markdown-content h5:not(:where(.not-content *)){font-size:var(--sl-text-h5)}.sl-markdown-content h6:not(:where(.not-content *)){font-size:var(--sl-text-h6)}.sl-markdown-content a:not(:where(.not-content *)){color:var(--sl-color-text-accent)}.sl-markdown-content a:hover:not(:where(.not-content *)){color:var(--sl-color-white)}.sl-markdown-content code:not(:where(.not-content *)){background-color:var(--sl-color-bg-inline-code);margin-block:-.125rem;padding:.125rem .375rem;font-size:var(--sl-text-code-sm)}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) code{font-size:inherit}.sl-markdown-content pre:not(:where(.not-content *)){border:1px solid var(--sl-color-gray-5);padding:.75rem 1rem;font-size:var(--sl-text-code);-moz-tab-size:2;-o-tab-size:2;tab-size:2}.sl-markdown-content pre code:not(:where(.not-content *)){all:unset;font-family:var(--__sl-font-mono)}.sl-markdown-content blockquote:not(:where(.not-content *)){border-inline-start:1px solid var(--sl-color-gray-5);padding-inline-start:1rem}.sl-markdown-content table:not(:where(.not-content *)){display:block;overflow:auto;border-collapse:collapse}.sl-markdown-content tr:nth-child(2n):not(:where(.not-content *)){background-color:var(--sl-color-gray-7, var(--sl-color-gray-6))}.sl-markdown-content :is(th,td):not(:where(.not-content *)){border:1px solid var(--sl-color-hairline-light);padding:.375rem .8125rem}.sl-markdown-content hr:not(:where(.not-content *)){border:0;border-bottom:1px solid var(--sl-color-hairline)}.sl-markdown-content h2{line-height:3.5rem}main:where(.astro-bvzihdzo){width:calc(100% - 2em);max-width:100%;margin:0}.hero-image:where(.astro-bvzihdzo){width:100%}.hero-image:where(.astro-bvzihdzo) img:where(.astro-bvzihdzo){display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.nacos-prose:where(.astro-bvzihdzo){width:90%;padding:1em;color:rgb(var(--gray-dark))}.title:where(.astro-bvzihdzo){margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title:where(.astro-bvzihdzo) h1:where(.astro-bvzihdzo){margin:0 0 .5em}.date:where(.astro-bvzihdzo){margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on:where(.astro-bvzihdzo){font-style:italic}
</style>
<link rel="stylesheet" href="/_astro/index.-itPl6ud.css" />
<style>@media (max-width: 36rem){html{font-size:12px}}
</style><script type="module" src="/_astro/hoisted.OxAi4q7n.js"></script>
<script type="module" src="/_astro/page.36aCzv65.js"></script></head> <body class="astro-37fxchfa"> <header-layout class="header bg-gray-14 relative astro-3ef6ksr2" style="position: sticky; height: 4rem; --justifyContent: space-between;"> <div data-modal-panel class="modal-panel hidden h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2" style="--justifyContent: space-between;"></div> <div style="height: 4rem; --justifyContent: space-between;" class="nav bg-gray-14 relative top-0 right-0 bottom-0 left-0 flex items-center justify-between astro-3ef6ksr2"> <!-- logo --> <a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png" style="--justifyContent: space-between;"> </a> <!-- 菜单 --> <div class="pc_nav_menu flex h-full items-center astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div data-docs class="h-full flex items-center p-0.5 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="title astro-3ef6ksr2" style="--justifyContent: space-between;">DOCS</span> <svg data-docs-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg" style="--justifyContent: space-between;"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path> </svg> </div> <div data-docs-dropdown style="top: 4rem; --justifyContent: space-between;" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2" style="--justifyContent: space-between;">Documentation</span> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-sm text-gray-02 astro-3ef6ksr2" style="--justifyContent: space-between;">1.x</span> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-sm text-gray-02 astro-3ef6ksr2" style="--justifyContent: space-between;">2.x</span> </a> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2" style="--justifyContent: space-between;">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div data-nacos-cloud class="h-full flex items-center p-0.5 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="title astro-3ef6ksr2" style="--justifyContent: space-between;">NACOS CLOUD</span> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2" style="--justifyContent: space-between;">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div data-community class="h-full flex items-center p-0.5 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="title astro-3ef6ksr2" style="--justifyContent: space-between;">COMMUNITY</span> <svg data-community-arrow class="arrow ml-2 astro-3ef6ksr2" width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg" style="--justifyContent: space-between;"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path> </svg> </div> <div data-community-dropdown style="top: 4rem; --justifyContent: space-between;" class="dropdown-panel bg-gray-14 hidden invisible opacity-0 absolute left-0 right-0 z-50 astro-3ef6ksr2"> <div class="flex pb-10 pt-14 px-24 justify-center astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="flex mr-32 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2" style="--justifyContent: space-between;">COMMUNITY</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Contact</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Report</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Contribute</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Stars</a> </div> <div class="shortcut-menu flex flex-col px-7 mr-14 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-10 mb-2 astro-3ef6ksr2" style="--justifyContent: space-between;">EVENTS</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Events</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">News</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/" style="--justifyContent: space-between;">Meetup</a> <span class="text-xs text-gray-10 mb-2 mt-10 astro-3ef6ksr2" style="--justifyContent: space-between;">Resources</span> <a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/blog" style="--justifyContent: space-between;">Blog</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/docs/ebook/iez8a4" style="--justifyContent: space-between;">E-book</a><a class="text-sm text-gray-02 mt-3  astro-3ef6ksr2" href="/download/nacos-service" style="--justifyContent: space-between;">Download</a> </div> </div> <div class="flex astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <img class=" astro-3ef6ksr2" src="/left-shortcut.png" style="--justifyContent: space-between;"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2" style="--justifyContent: space-between;">Key to service-centric (for example microservice or cloud-native) architectures.</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2" style="--justifyContent: space-between;">READ ARTICLE</button> </div><div class="shortcut-card bg-gray-13 rounded-2xl p-2 flex flex-col w-64 ml-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <img class=" astro-3ef6ksr2" src="/right-shortcut.png" style="--justifyContent: space-between;"> <div class="text-blue-01 text-sm mt-3 line-clamp-3 h-16 astro-3ef6ksr2" style="--justifyContent: space-between;">An easy-to-use platform for building cloud native applications</div> <button class="btn mt-8 w-fit text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl astro-3ef6ksr2" style="--justifyContent: space-between;">READ ARTICLE</button> </div> </div> </div> </div> </div> <span class="text-gray-06 text-xs astro-3ef6ksr2" style="--justifyContent: space-between;">|</span> <div class="menu-item h-full flex items-center cursor-pointer text-gray-06 text-sm px-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div data-demo class="h-full flex items-center p-0.5 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="title astro-3ef6ksr2" style="--justifyContent: space-between;">DEMO</span> </div> </div> </div> <!-- 右侧菜单 --> <div class="astro-3ef6ksr2" style="--justifyContent: space-between;">  </div> <!-- 小屏适配 --> <div class="mobile_nav_menu hidden cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2" style="--justifyContent: space-between;"> <svg class="cursor-pointer icon ml-4 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6304" width="24" height="24" style="--justifyContent: space-between;"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 479.169H438.553c-17.673 0-32 14.327-32 32s14.327 32 32 32h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM319.028 351.594l-160 160 160 160z" fill="#f4f4f6" p-id="6305" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path></svg> </button> </div> <!-- 移动端导航菜单 --> <div data-mobile-menu class="overflow-hidden hidden flex flex-col w-screen bg-gray-01 h-screen absolute left-0 right-0 top-0 astro-3ef6ksr2" style="--justifyContent: space-between;"> <!-- 顶部logo --> <div style="height: 4rem; --justifyContent: space-between;" class="mobile_nav bg-gray-14 px-8 flex items-center justify-start astro-3ef6ksr2"> <a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <img class="logo astro-3ef6ksr2" src="/nacos_white.png" style="--justifyContent: space-between;"> </a> <div class="menu_close flex items-center cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <button class="text-gray-01 bg-gray-14 flex items-center astro-3ef6ksr2" style="--justifyContent: space-between;"> <svg class="cursor-pointer icon ml-4 astro-3ef6ksr2" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7494" id="mx_n_1702523741163" width="24" height="24" style="--justifyContent: space-between;"><path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM192.028 543.17h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.028c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM705.162 671.594l160-160-160-160z" fill="#f4f4f6" p-id="7495" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path></svg> </button> </div> </div> <div data-mobile-menu-list class="w-full pl-8 astro-3ef6ksr2" style="--justifyContent: space-between;"> <ul class="list-none pl-0 astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <div mobile-menu-expand-docs class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">DOCS</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2" style="--justifyContent: space-between;"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path></svg> </button> </div> <div mobile-menu-expand-content-docs class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div mobile-menu-fold-docs class="flex items-center pt-8 pb-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038" style="--justifyContent: space-between;"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">DOCS</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2" style="--justifyContent: space-between;"></div> <div class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-07 astro-3ef6ksr2" style="--justifyContent: space-between;">Documentation</span> <ul class="pl-0 list-none astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/docs/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 astro-3ef6ksr2" style="--justifyContent: space-between;">1.x</li> </a><a href="/docs/v2/what-is-nacos" class="flex items-center mt-3 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 astro-3ef6ksr2" style="--justifyContent: space-between;">2.x</li> </a> </ul> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/nacosCloud" class="text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">NACOS CLOUD</a> </li> <li class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <div mobile-menu-expand-com class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <button class="pl-0 mt-4 bg-gray-01 flex items-center cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="mr-2 text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">COMMUNITY</span> <svg width="12" height="12" viewBox="0 0 9 14" fill="none" xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2" style="--justifyContent: space-between;"><path d="M1 1L7 7L1 13" stroke="#2e3038" stroke-width="2" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path></svg> </button> </div> <div mobile-menu-expand-content-com class="px-8 hidden invisible opacity-0 w-screen bg-gray-01 absolute left-0 right-0 top-16 astro-3ef6ksr2" style="--justifyContent: space-between;"> <div mobile-menu-fold-com class="flex items-center pt-8 pb-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="rotate-180 mr-4 astro-3ef6ksr2" fill="none" viewBox="0 0 9 14" stroke="#2e3038" style="--justifyContent: space-between;"> <path stroke-width="2" d="M1 1L7 7L1 13" class="astro-3ef6ksr2" style="--justifyContent: space-between;"></path> </svg> <span class="text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">COMMUNITY</span> </div> <div class="divider divider-vertical bg-gray-01 h-[0.05rem] astro-3ef6ksr2" style="--justifyContent: space-between;"></div> <div class="mobile_menu_community flex justify-between astro-3ef6ksr2" style="--justifyContent: space-between;"> <div class="mb-6 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-07 astro-3ef6ksr2" style="--justifyContent: space-between;">COMMUNITY</span> <ul class="pl-0 list-none astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Contact </li> </a><a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Report </li> </a><a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Contribute </li> </a><a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Stars </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-07 astro-3ef6ksr2" style="--justifyContent: space-between;">EVENTS</span> <ul class="pl-0 list-none astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Events </li> </a><a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> News </li> </a><a href="/" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Meetup </li> </a> </ul> </div> <div class="mb-6 astro-3ef6ksr2" style="--justifyContent: space-between;"> <span class="text-xs text-gray-07 astro-3ef6ksr2" style="--justifyContent: space-between;">Resources</span> <ul class="pl-0 list-none astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/blog" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Blog </li> </a><a href="/docs/ebook/iez8a4" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> E-book </li> </a><a href="/download/nacos-service" class="astro-3ef6ksr2" style="--justifyContent: space-between;"> <li class="text-sm text-gray-14 mt-2 cursor-pointer astro-3ef6ksr2" style="--justifyContent: space-between;"> Download </li> </a> </ul> </div> </div> </div> </li> <li class="mt-4 astro-3ef6ksr2" style="--justifyContent: space-between;"> <a href="/" class="text-gray-14 text-sm astro-3ef6ksr2" style="--justifyContent: space-between;">DEMO</a> </li> </ul> </div> </div> </div> </header-layout>    <div class="bg-gray-14 "> <div class="w-[70%] inline-block"> <div class="sl-markdown-content bg-gray-14 text-gray-01 astro-bvzihdzo"> <div class="hero-image  astro-bvzihdzo">  </div> <div class="nacos-prose mx-auto astro-bvzihdzo"> <div class="title astro-bvzihdzo"> <div class="date astro-bvzihdzo"> 2022-08-05  </div> <h1 class="astro-bvzihdzo">小米Nacos2.0扩缩容最佳实践</h1> <hr class="astro-bvzihdzo"> </div>  <h1 id="一背景">一、背景</h1>
<p>小米是从1.x版本开始使用Nacos，后来为了性能升级到了2.0.3版本，一直在开启双写的情况下运行稳定，动态的服务发现与分布式配置中心的能力也满足我们的预期，随着使用我们集群的体量越来越大，需要对集群进行扩容，但在实际操作过程中遇到了一些问题，这篇文章主要总结一下集群扩缩容中遇到问题的解决过程和集群扩缩容步骤。</p>
<h1 id="二集群扩缩容出现的问题">二、集群扩缩容出现的问题</h1>
<h2 id="一-发现服务降级问题">(一) 发现服务降级问题</h2>
<p>我们在进行扩容的过程中发现新部署的节点和原有的一个节点的集群管理中的元数据出现了 readyToUpgrade: false，并且经过测试发现这两个节点无法使用2.x版本的SDK进行注册服务，但是可以使用1.x版本的SDK注册，说明原本2.0.3版本的服务端从功能上降级为了1.x版本。</p>
<h2 id="二-服务降级的排查过程">(二) 服务降级的排查过程</h2>
<h3 id="查看管理后台集群管理元数据">查看管理后台集群管理元数据</h3>
<p>我们发现在集群管理元数据出现readyToUpgrade: false，通过查看readyToUpgrade相关的源码发现：首次启动时，默认处于未升级状态，此时会开启一个定时任务，检查服务数量与实例数量是否与监控一致，并且是否当前不存在双写任务，如果条件满足则将 readyToUpgrade 字段设置成true，并且通知给其他集群。定时任务会定时判断是否所有实例都满足升级条件，如果满足，则执行升级操作。当我们进行扩容操作的时候，因为新节点刚部署的时候，老节点地址列表没有新节点，新节点是无法完成自动升级的，所以集群管理的节点元数据会出现 readyToUpgrade: false。</p>
<h3 id="查看服务端日志">查看服务端日志</h3>
<p>我们在非新节点的日志文件中发现了服务降级的相关日志。</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.t1efu.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#e1e4e8">2022-03-09 17:51:42,262 INFO Downgrade to 1.X</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="2022-03-09 17:51:42,262 INFO Downgrade to 1.X"><div></div></button></div></figure></div>
<p>根据服务降级日志“Downgrade to 1.X”在代码中全局搜索找到了对应的类UpgradeJudgement。</p>
<p>经过分析UpgradeJudgement源码逻辑，只要满足如下其中一个条件便会出现服务降级：</p>
<ol>
<li>版本信息存在，但是小于2.x。</li>
</ol>
<p>只有手动通过操作部署低版本节点才可能出现该情况，该设计应该是为了防止升级后的集群有问题需要降级，利用该原理需要降级的时候，只要重新部署一个低版本的节点其他节点可自动降级。</p>
<ol start="2">
<li>UpgradeJudgement收到MembersChangeEvent事件，但是member信息中版本为空。</li>
</ol>
<p>老的版本的集群没有收集节点的版本信息，这里版本为空也降级是为了兼容这部分集群，我们之所以出现意料之外的降级也和这个直接相关。</p>
<p>关键源码：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">public void onEvent(MembersChangeEvent event) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    if (!event.hasTriggers()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        Loggers.SRV_LOG.info("Member change without no trigger. "</span></div><div class="ec-line"><span style="--0:#E1E4E8">                + "It may be triggered by member lookup on startup. "                + "Skip.");</span></div><div class="ec-line"><span style="--0:#E1E4E8">        return;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.SRV_LOG.info("member change, event: {}", event);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    for (Member each : event.getTriggers()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        Object versionStr = each.getExtendVal(MemberMetaDataConstants.VERSION);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        // come from below 1.3.0</span></div><div class="ec-line"><span style="--0:#E1E4E8">        if (null == versionStr) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            checkAndDowngrade(false);</span></div><div class="ec-line"><span style="--0:#E1E4E8">            all20XVersion.set(false);</span></div><div class="ec-line"><span style="--0:#E1E4E8">            return;</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">        Version version = VersionUtil.parseVersion(versionStr.toString());</span></div><div class="ec-line"><span style="--0:#E1E4E8">        if (version.getMajorVersion() &#x3C; MAJOR_VERSION) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            checkAndDowngrade(version.getMinorVersion() >= MINOR_VERSION)</span></div><div class="ec-line"><span style="--0:#E1E4E8">;            all20XVersion.set(false);</span></div><div class="ec-line"><span style="--0:#E1E4E8">            return;</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    all20XVersion.set(true);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void onEvent(MembersChangeEvent event) {    if (!event.hasTriggers()) {        Loggers.SRV_LOG.info(&#x22;Member change without no trigger. &#x22;                + &#x22;It may be triggered by member lookup on startup. &#x22;                + &#x22;Skip.&#x22;);        return;    }    Loggers.SRV_LOG.info(&#x22;member change, event: {}&#x22;, event);    for (Member each : event.getTriggers()) {        Object versionStr = each.getExtendVal(MemberMetaDataConstants.VERSION);        // come from below 1.3.0        if (null == versionStr) {            checkAndDowngrade(false);            all20XVersion.set(false);            return;        }        Version version = VersionUtil.parseVersion(versionStr.toString());        if (version.getMajorVersion() < MAJOR_VERSION) {            checkAndDowngrade(version.getMinorVersion() >= MINOR_VERSION);            all20XVersion.set(false);            return;        }    }    all20XVersion.set(true);}"><div></div></button></div></figure></div>
<h3 id="服务降级源码分析">服务降级源码分析</h3>
<p>MemberInfoReportTask每隔5秒调用其他节点的/cluster/report 接口上报自己的member数据。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">    class MemberInfoReportTask extends Task {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        private final GenericType&#x3C;</span><span style="--0:#85E89D">RestResult</span><span style="--0:#E1E4E8">&#x3C;String>> reference = new GenericType&#x3C;</span><span style="--0:#85E89D">RestResult</span><span style="--0:#E1E4E8">&#x3C;String>>() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        };</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        private int cursor = 0;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">        protected void executeBody() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            List&#x3C;</span><span style="--0:#85E89D">Member</span><span style="--0:#E1E4E8">> members = ServerMemberManager.this.allMembersWithoutSelf();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">            if (members.isEmpty()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                return;</span></div><div class="ec-line"><span style="--0:#E1E4E8">            }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">            this.cursor = (this.cursor + 1) % members.size();</span></div><div class="ec-line"><span style="--0:#E1E4E8">            Member target = members.get(cursor);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">            Loggers.CLUSTER.debug("report the metadata to the node : {}", target.getAddress());</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">            final String url = HttpUtils</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    .buildUrl(false, target.getAddress(), EnvUtil.getContextPath(), Commons.NACOS_CORE_CONTEXT,</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            "/cluster/report");</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">            try {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                Header header = Header.newInstance().addParam(Constants.NACOS_SERVER_HEADER, VersionUtils.version);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                AuthHeaderUtil.addIdentityToHeader(header);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                asyncRestTemplate</span></div><div class="ec-line"><span style="--0:#E1E4E8">                        .post(url, header, Query.EMPTY, getSelf(), reference.getType(), new Callback&#x3C;</span><span style="--0:#85E89D">String</span><span style="--0:#E1E4E8">>() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            public void onReceive(RestResult&#x3C;</span><span style="--0:#85E89D">String</span><span style="--0:#E1E4E8">> result) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                if (result.getCode() == HttpStatus.NOT_IMPLEMENTED.value()</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        || result.getCode() == HttpStatus.NOT_FOUND.value()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    Loggers.CLUSTER</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                            .warn("{} version is too low, it is recommended to upgrade the version : {}",</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                                    target, VersionUtils.version);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    Member memberNew = null;</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    if (target.getExtendVal(MemberMetaDataConstants.VERSION) != null) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        memberNew = target.copy();</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        // Clean up remote version info.</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        // This value may still stay in extend info when remote server has been downgraded to old version.</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        memberNew.delExtendVal(MemberMetaDataConstants.VERSION);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        memberNew.delExtendVal(MemberMetaDataConstants.READY_TO_UPGRADE);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        Loggers.CLUSTER.warn("{} : Clean up version info,"</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                                + " target has been downgrade to old version.", memberNew);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    if (target.getAbilities() != null</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                            </span><span style="--0:#FDAEB7;--0fs:italic">&#x26;&#x26;</span><span style="--0:#E1E4E8"> target.getAbilities().getRemoteAbility() != null </span><span style="--0:#FDAEB7;--0fs:italic">&#x26;&#x26;</span><span style="--0:#E1E4E8"> target.getAbilities()</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                            .getRemoteAbility().isSupportRemoteConnection()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        if (memberNew == null) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                            memberNew = target.copy();</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        memberNew.getAbilities().getRemoteAbility().setSupportRemoteConnection(false);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        Loggers.CLUSTER</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                                .warn("{} : Clear support remote connection flag,target may rollback version ",</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                                        memberNew);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    if (memberNew != null) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        update(memberNew);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    return;</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                if (result.ok()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    MemberUtil.onSuccess(ServerMemberManager.this, target);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                } else {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    Loggers.CLUSTER.warn("failed to report new info to target node : {}, result : {}",</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                            target.getAddress(), result);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                    MemberUtil.onFail(ServerMemberManager.this, target);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">                            @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            public void onError(Throwable throwable) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                Loggers.CLUSTER.error("failed to report new info to target node : {}, error : {}",</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                        target.getAddress(), ExceptionUtil.getAllExceptionMsg(throwable));</span></div><div class="ec-line"><span style="--0:#E1E4E8">                                MemberUtil.onFail(ServerMemberManager.this, target, throwable);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">                            @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">                            public void onCancel() {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">                            }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                        });</span></div><div class="ec-line"><span style="--0:#E1E4E8">            } catch (Throwable ex) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                Loggers.CLUSTER.error("failed to report new info to target node : {}, error : {}", target.getAddress(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">                        ExceptionUtil.getAllExceptionMsg(ex));</span></div><div class="ec-line"><span style="--0:#E1E4E8">            }</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">        protected void after() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            GlobalExecutor.scheduleByCommon(this, 2_000L);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="    class MemberInfoReportTask extends Task {        private final GenericType<RestResult<String>> reference = new GenericType<RestResult<String>>() {        };        private int cursor = 0;        @Override        protected void executeBody() {            List<Member> members = ServerMemberManager.this.allMembersWithoutSelf();            if (members.isEmpty()) {                return;            }            this.cursor = (this.cursor + 1) % members.size();            Member target = members.get(cursor);            Loggers.CLUSTER.debug(&#x22;report the metadata to the node : {}&#x22;, target.getAddress());            final String url = HttpUtils                    .buildUrl(false, target.getAddress(), EnvUtil.getContextPath(), Commons.NACOS_CORE_CONTEXT,                            &#x22;/cluster/report&#x22;);            try {                Header header = Header.newInstance().addParam(Constants.NACOS_SERVER_HEADER, VersionUtils.version);                AuthHeaderUtil.addIdentityToHeader(header);                asyncRestTemplate                        .post(url, header, Query.EMPTY, getSelf(), reference.getType(), new Callback<String>() {                            @Override                            public void onReceive(RestResult<String> result) {                                if (result.getCode() == HttpStatus.NOT_IMPLEMENTED.value()                                        || result.getCode() == HttpStatus.NOT_FOUND.value()) {                                    Loggers.CLUSTER                                            .warn(&#x22;{} version is too low, it is recommended to upgrade the version : {}&#x22;,                                                    target, VersionUtils.version);                                    Member memberNew = null;                                    if (target.getExtendVal(MemberMetaDataConstants.VERSION) != null) {                                        memberNew = target.copy();                                        // Clean up remote version info.                                        // This value may still stay in extend info when remote server has been downgraded to old version.                                        memberNew.delExtendVal(MemberMetaDataConstants.VERSION);                                        memberNew.delExtendVal(MemberMetaDataConstants.READY_TO_UPGRADE);                                        Loggers.CLUSTER.warn(&#x22;{} : Clean up version info,&#x22;                                                + &#x22; target has been downgrade to old version.&#x22;, memberNew);                                    }                                    if (target.getAbilities() != null                                            &#x26;&#x26; target.getAbilities().getRemoteAbility() != null &#x26;&#x26; target.getAbilities()                                            .getRemoteAbility().isSupportRemoteConnection()) {                                        if (memberNew == null) {                                            memberNew = target.copy();                                        }                                        memberNew.getAbilities().getRemoteAbility().setSupportRemoteConnection(false);                                        Loggers.CLUSTER                                                .warn(&#x22;{} : Clear support remote connection flag,target may rollback version &#x22;,                                                        memberNew);                                    }                                    if (memberNew != null) {                                        update(memberNew);                                    }                                    return;                                }                                if (result.ok()) {                                    MemberUtil.onSuccess(ServerMemberManager.this, target);                                } else {                                    Loggers.CLUSTER.warn(&#x22;failed to report new info to target node : {}, result : {}&#x22;,                                            target.getAddress(), result);                                    MemberUtil.onFail(ServerMemberManager.this, target);                                }                            }                            @Override                            public void onError(Throwable throwable) {                                Loggers.CLUSTER.error(&#x22;failed to report new info to target node : {}, error : {}&#x22;,                                        target.getAddress(), ExceptionUtil.getAllExceptionMsg(throwable));                                MemberUtil.onFail(ServerMemberManager.this, target, throwable);                            }                            @Override                            public void onCancel() {                            }                        });            } catch (Throwable ex) {                Loggers.CLUSTER.error(&#x22;failed to report new info to target node : {}, error : {}&#x22;, target.getAddress(),                        ExceptionUtil.getAllExceptionMsg(ex));            }        }        @Override        protected void after() {            GlobalExecutor.scheduleByCommon(this, 2_000L);        }    }"><div></div></button></div></figure></div>
<p>当调用失败时会执行MemberUtil的onFail方法</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">    public static void onFail(final ServerMemberManager manager, final Member member, Throwable ex) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        manager.getMemberAddressInfos().remove(member.getAddress());</span></div><div class="ec-line"><span style="--0:#E1E4E8">        final NodeState old = member.getState();</span></div><div class="ec-line"><span style="--0:#E1E4E8">        member.setState(NodeState.SUSPICIOUS);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        member.setFailAccessCnt(member.getFailAccessCnt() + 1);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        int maxFailAccessCnt = EnvUtil.getProperty(MEMBER_FAIL_ACCESS_CNT_PROPERTY, Integer.class, DEFAULT_MEMBER_FAIL_ACCESS_CNT);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        // If the number of consecutive failures to access the target node reaches</span></div><div class="ec-line"><span style="--0:#E1E4E8">        // a maximum, or the link request is rejected, the state is directly down</span></div><div class="ec-line"><span style="--0:#E1E4E8">        if (member.getFailAccessCnt() > maxFailAccessCnt || StringUtils</span></div><div class="ec-line"><span style="--0:#E1E4E8">                .containsIgnoreCase(ex.getMessage(), TARGET_MEMBER_CONNECT_REFUSE_ERRMSG)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            member.setState(NodeState.DOWN);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">        if (!Objects.equals(old, member.getState())) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            manager.notifyMemberChange(member);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="    public static void onFail(final ServerMemberManager manager, final Member member, Throwable ex) {        manager.getMemberAddressInfos().remove(member.getAddress());        final NodeState old = member.getState();        member.setState(NodeState.SUSPICIOUS);        member.setFailAccessCnt(member.getFailAccessCnt() + 1);        int maxFailAccessCnt = EnvUtil.getProperty(MEMBER_FAIL_ACCESS_CNT_PROPERTY, Integer.class, DEFAULT_MEMBER_FAIL_ACCESS_CNT);        // If the number of consecutive failures to access the target node reaches        // a maximum, or the link request is rejected, the state is directly down        if (member.getFailAccessCnt() > maxFailAccessCnt || StringUtils                .containsIgnoreCase(ex.getMessage(), TARGET_MEMBER_CONNECT_REFUSE_ERRMSG)) {            member.setState(NodeState.DOWN);        }        if (!Objects.equals(old, member.getState())) {            manager.notifyMemberChange(member);        }    }"><div></div></button></div></figure></div>
<p>在onFail方法中，会判断节点状态是否发生了改变，比如由UP变为SUSPICIOUS，如果发生了改变，则会执行manager.notifyMemberChange(member)。在前面复现降级的场景下，存在一个节点宕机，所以重启的节点report宕机节点时一定会触发MemberUtil的onFail方法的执行，而当前重启的节点持有的宕机节点状态默认是UP,当执行onFail时，会变成SUSPICIOUS，所以会执行manager.notifyMemberChange(member)，发布MembersChangeEvent事件，由于这个事件是由宕机节点触发的，所以MembersChangeEvent事件中trigger的member版本号为null，UpgradeJudgement收到MembersChangeEvent事件，并且member信息中版本为空，根据第2点的结论，此时会触发当前节点降级</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">void notifyMemberChange(Member member) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        NotifyCenter.publishEvent(MembersChangeEvent.builder().trigger(member).members(allMembers()).build());</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="void notifyMemberChange(Member member) {        NotifyCenter.publishEvent(MembersChangeEvent.builder().trigger(member).members(allMembers()).build());}"><div></div></button></div></figure></div>
<h3 id="服务降级过程时序图">服务降级过程时序图</h3>
<p>为了方便理解，画了如下简单的时序图，省略了一些return和异步执行</p>
<p><img src="/img/blog/image_xiaomi_2022.png" alt="image_xiaomi_2022.jpg"></p>
<h3 id="为什么关闭双写后服务不会降级">为什么关闭双写后服务不会降级</h3>
<p>前面已经提到，降级的必要条件是UpgradeJudgement收到MembersChangeEvent，关闭双写后，UpgradeJudgement会取消订阅MembersChangeEvent，并且将双写是否关闭的值通过jraft写入到磁盘，当服务启动时又会重新加载到内存从而取消订阅MembersChangeEvent。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">private class DoubleWriteEnabledChecker extends Thread {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        private volatile boolean stillCheck = true;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        @Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">        public void run() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">            Loggers.SRV_LOG.info("Check whether close double write");</span></div><div class="ec-line"><span style="--0:#E1E4E8">            while (stillCheck) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                try {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    TimeUnit.SECONDS.sleep(5);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    stopDoubleWrite = !ApplicationUtils.getBean(SwitchDomain.class).isDoubleWriteEnabled();</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    if (stopDoubleWrite) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                        upgradeJudgement.stopAll();</span></div><div class="ec-line"><span style="--0:#E1E4E8">                        stillCheck = false;</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">                } catch (Exception e) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">                    Loggers.SRV_LOG.error("Close double write failed ", e);</span></div><div class="ec-line"><span style="--0:#E1E4E8">                }</span></div><div class="ec-line"><span style="--0:#E1E4E8">            }</span></div><div class="ec-line"><span style="--0:#E1E4E8">            Loggers.SRV_LOG.info("Check double write closed");</span></div><div class="ec-line"><span style="--0:#E1E4E8">        }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private class DoubleWriteEnabledChecker extends Thread {        private volatile boolean stillCheck = true;        @Override        public void run() {            Loggers.SRV_LOG.info(&#x22;Check whether close double write&#x22;);            while (stillCheck) {                try {                    TimeUnit.SECONDS.sleep(5);                    stopDoubleWrite = !ApplicationUtils.getBean(SwitchDomain.class).isDoubleWriteEnabled();                    if (stopDoubleWrite) {                        upgradeJudgement.stopAll();                        stillCheck = false;                    }                } catch (Exception e) {                    Loggers.SRV_LOG.error(&#x22;Close double write failed &#x22;, e);                }            }            Loggers.SRV_LOG.info(&#x22;Check double write closed&#x22;);        }    }"><div></div></button></div></figure></div>
<h3 id="本地复现服务降级">本地复现服务降级</h3>
<p>在本地以2.0.3版本启动三个节点(node1、node2、node3)的集群模式，等三个节点都运行稳定后，查看其中每个节点数据目录（${nacos.home}/data/upgrade.state）下的升级状态都为true，说明三个节点目前都是2.x版本的状态。此时关闭node3节点，重启node1节点，启动完成后，发现node1此时会发生服务降级。</p>
<h3 id="服务降级排查结论">服务降级排查结论</h3>
<p>在2.0.3版本默认开启双写，只要nacos集群其中一个节点挂掉，剩余节点如果不将这个节点从地址列表中移除，只要重启便会出现服务降级；另外在并发部署的情况下，也有可能出现服务降级。
关闭双写会关闭运行中服务降级的入口，所以2.x服务运行稳定后一定要关闭双写，我们的服务之所以会降级也是因为运行后未关闭双写。</p>
<h2 id="三-临时解决方案">(三) 临时解决方案</h2>
<p>由于我们的Nacos集群已经正常升级到了2.0.3，并且稳定运行了一段时间，已经有很多客户端在使用2.x的版本，节点出现降级会导致这部分客户端无法进行注册，所以无论在任何情况下，都不能出现服务降级，决定执行如下方案：</p>
<ol>
<li>扩容时新节点启动完成后关闭双写，强制新节点升级到2.x版本。</li>
<li>暂时先将服务降级的方法代码逻辑删除，只打印日志。
代码改动如下：</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">private void checkAndDowngrade(boolean jraftFeature) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.SRV_LOG.info("jraftFeature:{} ignore Downgrade to 1.X", jraftFeature);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void checkAndDowngrade(boolean jraftFeature) {    Loggers.SRV_LOG.info(&#x22;jraftFeature:{} ignore Downgrade to 1.X&#x22;, jraftFeature);}"><div></div></button></div></figure></div>
<h2 id="四-社区解决方案">(四) 社区解决方案</h2>
<p>我们将服务降级的问题也反馈给Nacos PMC席翁，在社区Nacos2.1.0正式版中，已经默认关闭了兼容 1.X 服务端升级，所以只要不手动开启，2.x的Nacos不可能在出现服务降级的问题，后续我们也会逐步将所有共有集群升级到2.1.0版本。</p>
<p>关闭兼容1.x服务端升级的功能对应PR：<a href="https://github.com/alibaba/nacos/pull/8016" rel="noopener noreferrer" target="_blank">https://github.com/alibaba/nacos/pull/8016</a></p>
<h1 id="三集群扩缩容推荐">三、集群扩缩容推荐</h1>
<p>扩缩容使用的运维接口</p>
<p>关闭双写 ：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">/nacos/v1/ns/operator/switchesentry=doubleWriteEnabled</span><span style="--0:#FDAEB7;--0fs:italic">&#x26;</span><span style="--0:#E1E4E8">value=false</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/nacos/v1/ns/operator/switchesentry=doubleWriteEnabled&#x26;value=false"><div></div></button></div></figure></div>
<p>查看节点监控：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">/nacos/v1/ns/upgrade/ops/metrics</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/nacos/v1/ns/upgrade/ops/metrics"><div></div></button></div></figure></div>
<h2 id="一-集群扩容操作步骤">(一) 集群扩容操作步骤</h2>
<ol>
<li>部署新节点。</li>
<li>关闭新节点双写，检查日志是否出现如下日志，如果naming-raft出现了如下日志，说明降级入口已自动关闭。</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">start to close old raft protocol!!!</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="start to close old raft protocol!!!"><div></div></button></div></figure></div>
<ol start="3">
<li>通过metrics接口查看双写是否关闭成功</li>
<li>手动修改老节点集群配置文件 cluster.conf，无须重启。</li>
<li>使用metrics接口查看新节点数据是否与老节点一致。</li>
<li>测试新节点服务注册与发现，配置添加与查询等基本功能是否正常。</li>
</ol>
<h2 id="二-集群缩容操作步骤">(二) 集群缩容操作步骤</h2>
<ol>
<li>nginx 去掉待移除节点ip。</li>
<li>修改保留节点集群配置文件cluster.conf，无须重启，等待所有节点数据一致。</li>
<li>观察nginx日志，确保移除merger节点无流量。</li>
<li>top待移除节点，检查保留节点状态，模拟注册验证。</li>
</ol>
<p>若是操作机器降配，需要先停服，再停机器，不然可能出现raft数据压缩包有问题的情况。</p>
<h2 id="三-扩缩容优化点">(三) 扩缩容优化点</h2>
<p>目前我们每次进行扩缩容都需要修改每个节点的cluster.conf文件，操作非常繁琐，其实nacos提供了nacos-address 组件，引入nacos-address组件后进行扩缩容时无须一台一台修改地址，只需要修改Nacos-adress服务中的地址即可，可大大提升扩缩容效率。</p>
<h1 id="四总结">四、总结</h1>
<p>1.x版本升级到2.1.0之前的版本并且运行稳定后，必须关闭双写。</p>
<p>新集群统一使用2.1.0版本进行部署，否则在一定的场景下可能出现服务降级导致部分节点不可用。</p>
<p>对于体量较大的集群，需要引入nacos-address组件管理集群节点，避免手动频繁手动修改文件导致的误操作提升扩缩容效率。</p>  </div> </div>  </div> <div class="inline-block w-[30%] fixed bg-gray-14 h-full"> <aside> <div class="nav myroot prose"><ul>
<li>
<p><a href="#%E5%B0%8F%E7%B1%B3nacos20%E6%89%A9%E7%BC%A9%E5%AE%B9%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">小米Nacos2.0扩缩容最佳实践</a></p>
</li>
<li>
<p><a href="#%E4%B8%80%E8%83%8C%E6%99%AF">一、背景</a></p>
</li>
<li>
<p><a href="#%E4%BA%8C%E9%9B%86%E7%BE%A4%E6%89%A9%E7%BC%A9%E5%AE%B9%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98">二、集群扩缩容出现的问题</a></p>
<ul>
<li>
<p><a href="#%E4%B8%80-%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E9%97%AE%E9%A2%98">(一) 发现服务降级问题</a></p>
</li>
<li>
<p><a href="#%E4%BA%8C-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E7%9A%84%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B">(二) 服务降级的排查过程</a></p>
<ul>
<li><a href="#%E6%9F%A5%E7%9C%8B%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%85%83%E6%95%B0%E6%8D%AE">查看管理后台集群管理元数据</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%97%A5%E5%BF%97">查看服务端日志</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">服务降级源码分析</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E8%BF%87%E7%A8%8B%E6%97%B6%E5%BA%8F%E5%9B%BE">服务降级过程时序图</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%85%B3%E9%97%AD%E5%8F%8C%E5%86%99%E5%90%8E%E6%9C%8D%E5%8A%A1%E4%B8%8D%E4%BC%9A%E9%99%8D%E7%BA%A7">为什么关闭双写后服务不会降级</a></li>
<li><a href="#%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7">本地复现服务降级</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E6%8E%92%E6%9F%A5%E7%BB%93%E8%AE%BA">服务降级排查结论</a></li>
</ul>
</li>
<li>
<p><a href="#%E4%B8%89-%E4%B8%B4%E6%97%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">(三) 临时解决方案</a></p>
</li>
<li>
<p><a href="#%E5%9B%9B-%E7%A4%BE%E5%8C%BA%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">(四) 社区解决方案</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#%E4%B8%89%E9%9B%86%E7%BE%A4%E6%89%A9%E7%BC%A9%E5%AE%B9%E6%8E%A8%E8%8D%90">三、集群扩缩容推荐</a></p>
<ul>
<li><a href="#%E4%B8%80-%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4">(一) 集群扩容操作步骤</a></li>
<li><a href="#%E4%BA%8C-%E9%9B%86%E7%BE%A4%E7%BC%A9%E5%AE%B9%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4">(二) 集群缩容操作步骤</a></li>
<li><a href="#%E4%B8%89-%E6%89%A9%E7%BC%A9%E5%AE%B9%E4%BC%98%E5%8C%96%E7%82%B9">(三) 扩缩容优化点</a></li>
</ul>
</li>
<li>
<p><a href="#%E5%9B%9B%E6%80%BB%E7%BB%93">四、总结</a></p>
</li>
</ul></div> </aside> </div> </div>   </body> </html>